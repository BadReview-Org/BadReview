@using System.Threading.Tasks
@using BadReview.Shared.DTOs.Request
@using BadReview.Shared.Utils
@inherits LayoutComponentBase
@* Required *@
<MudThemeProvider @bind-IsDarkMode="@_isDarkMode" Theme="_theme"/>
<MudPopoverProvider />

@* Needed for dialogs *@
<MudDialogProvider />

@* Needed for snackbars *@
<MudSnackbarProvider />

@inject HttpClient Client
@inject ILogger<MainLayout> Logger
@inject AuthService AuthService
@inject AuthenticationStateProvider _provider

@inject IJSRuntime js

@inject ApiService ApiService
@inject NavigationManager Navigation

<MudLayout>
    <MudAppBar>
        <MudIconButton Icon="@Icons.Material.Filled.Menu" Color="Color.Inherit" Edge="Edge.Start" OnClick="DrawerToggle" />

        @if(!_isDarkMode){
            <MudImage Src="icon-192.png" Alt="BadReview Logo" Height="100" Style="cursor: pointer;" @onclick='() => Navigation.NavigateTo("/")' />
        }
        else{
            <MudImage Src="icon-192_white.png" Alt="BadReview Logo Dark" Height="100" Style="cursor: pointer;" @onclick='() => Navigation.NavigateTo("/")' />
        }
        <CustomFilter @bind-Value="_searchText" SearchGames="OnSearchGames" Placeholder="Search for games..." />

        <MudMenu Icon="@Icons.Material.Filled.MoreVert" Color="Color.Inherit" AriaLabel="Open user menu" Dense="true">
            <AuthorizeView>
                <Authorized>
                    <MudMenuItem OnClick="LogToken" Label="Profile"/>
                    <MudMenuItem Label="My account"/>
                    <MudMenuItem OnClick="LogoutAsync" Label="Log out"/>
                </Authorized>
                <NotAuthorized>
                    <MudMenuItem Href="/login" Label="Log in" />
                </NotAuthorized>
            </AuthorizeView>


            <MudDivider></MudDivider>

            <MudMenuItem OnClick="DarkModeToogle" AutoClose="false">
                <MudStack Row="true" AlignItems="AlignItems.Center" Spacing="1">
                    <MudText Typo=Typo.body2>Dark Mode</MudText>
                    <MudSwitch @bind-Value="_isDarkMode" ReadOnly="true" Color="Color.Primary"
                        T="bool" Size="Size.Medium"
                        ThumbIcon="@(_isDarkMode==true ? Icons.Material.Outlined.DarkMode : Icons.Material.Outlined.WbSunny)"
                        ThumbIconColor="@(_isDarkMode==true ? Color.Info : Color.Error)"/>
                </MudStack>
            </MudMenuItem>
        </MudMenu>

    </MudAppBar>
    <MudDrawer @bind-Open="@_drawerOpen" Fixed="true" Variant="@DrawerVariant.Mini" OpenMiniOnHover="true">
        <NavMenu/>
    </MudDrawer>
    <MudMainContent>
        <MudContainer Class="pa-8" MaxWidth="MaxWidth.Large">
            <CascadingValue Value="_provider">
                <CascadingValue Value="AuthService">
                    @Body
                </CascadingValue>
            </CascadingValue>
        </MudContainer>
    </MudMainContent>
</MudLayout>

@code {
    private string _searchText = string.Empty;

    private async Task<IEnumerable<BasicGameDto>> OnSearchGames(string searchText)
    {    
        ApiRequest apiRequest = new ApiRequest{
            URI = APIUTILS.URIS.GAMES, 
            PageSize = 30,
            OrderBy = "total_rating_count",
            Order = SortOrder.DSC,
            Page = 0 };

        if (string.IsNullOrWhiteSpace(searchText))
        {
            // Retornar todos los juegos
            var allGames = await ApiService.GetManyAsync<BasicGameDto>(apiRequest);
            return allGames?.Data ?? Enumerable.Empty<BasicGameDto>();
        }
        apiRequest.Filters = $"@name ~ *\"{searchText}\"*";
        Console.WriteLine($"🔍 Buscando juegos con filtro: {apiRequest.Filters}");
        PagedResult<BasicGameDto>? responseDto = await ApiService.GetManyAsync<BasicGameDto>(apiRequest);
        if (responseDto != null)
        {
            return responseDto?.Data ?? Enumerable.Empty<BasicGameDto>();
        }
        return Enumerable.Empty<BasicGameDto>();
    }

    [CascadingParameter]
    Task<AuthenticationState>? authStateTask { get; set; }
    AuthenticationState authState = null!;
    JWTAuthStateProvider stateProvider = null!;

    private MudTheme _theme = new MudTheme();
    private bool _isDarkMode;
    bool _drawerOpen = true;
    bool disableDarkModeToggle = false;

    async Task DarkModeToogle() {
        if (!disableDarkModeToggle)
        {
            _isDarkMode = !_isDarkMode;
            await js.InvokeVoidAsync("localStorage.setItem", "isDarkMode", _isDarkMode);
            Console.WriteLine("DarkModeToogle");
            disableDarkModeToggle = true;
            await Task.Delay(500);
            disableDarkModeToggle = false;
        }
    }

    void DrawerToggle() => _drawerOpen = !_drawerOpen;

    //private async void LoginAsync() => await AuthService.LoginAsync(stateProvider,"lauti", "hola123"); 

    private async void LogoutAsync() => await AuthService.LogoutAsync(stateProvider); 

    private void LogToken() => AuthService.LogJWToken(authState, Logger); 

    protected override async Task OnInitializedAsync()
    {
        authState = await authStateTask!;
        stateProvider = (JWTAuthStateProvider)_provider;
        try{
            var darkModeValue = await js.InvokeAsync<string>("localStorage.getItem", "isDarkMode");
            _isDarkMode = darkModeValue == "true";
        }
        catch{
             _isDarkMode = false;
        }

    }
}