@using System.Threading.Tasks
@using BadReview.Shared.DTOs.Request
@using BadReview.Shared.Utils
@using MudBlazor
@inherits LayoutComponentBase
@* Required *@
<MudThemeProvider @bind-IsDarkMode="DarkMode" Theme="_theme"/>
<MudPopoverProvider />

@* Needed for dialogs *@
<MudDialogProvider />

@* Needed for snackbars *@
<MudSnackbarProvider />

@inject HttpClient Client
@inject ILogger<MainLayout> Logger
@inject AuthService AuthService
@inject AuthenticationStateProvider _provider
@inject ISnackbar Snackbar

@inject IJSRuntime js

@inject ApiService ApiService
@inject NavigationManager Navigation

<MudLayout>
    <MudAppBar>
        <MudIconButton Icon="@Icons.Material.Filled.Menu" Color="Color.Inherit" Edge="Edge.Start" OnClick="DrawerToggle" />
        
        <MudSpacer />
        
        <CascadingValue Value="_isDarkMode" Name="IsDarkMode">
            <CustomDropdown 
                T="BasicGameDto"
                ToStringFunc="@(game => game?.Name ?? "")"
                DropdownChanged="OnDropdownSelected"
                SearchElements="OnSearchGames"
                Label="Search for games..."
                ClearOnNavigation="true"
                MinChars="3">
                <ItemTemplate Context="game">
                    <MudStack Row="true" AlignItems="AlignItems.Center" Spacing="2">
                        <img src="@ImageHelper.GetCoverUrl(game.CoverId)" 
                            style="width: auto; height: 60px; object-fit: cover; border-radius: 4px;" />
                        <MudStack Spacing="1">
                            <MudText Typo="Typo.subtitle1">@game.Name</MudText>
                            <MudStack Row="true" AlignItems="AlignItems.Center" Spacing="2">
                                @if(_isDarkMode)
                                {
                                    <img src="icons/igdb/IGDB_logo-white.svg.png" alt="IGDB" style="height: 14px; width: auto; opacity: 0.8;" />
                                }
                                else{
                                    <img src="icons/igdb/IGDB_logo.svg.png" alt="IGDB" style="height: 14px; width: auto; opacity: 0.8;" />
                                }
                                <MudText Typo="Typo.subtitle2">@(((double)(game?.RatingIGDB ?? 0) / 10).ToString("F1", System.Globalization.CultureInfo.InvariantCulture))</MudText>
                            </MudStack>
                        </MudStack>
                    </MudStack>
                </ItemTemplate>
            </CustomDropdown>
        </CascadingValue>
        
        <MudSpacer/>

        @if(!_isDarkMode){
            <MudImage Src="icons/badreview/logo_full_256x256.png" Alt="BadReview Logo" Height="45"
                Class="mr-6 mud-elevation-hover" Style="cursor: pointer;" @onclick='() => Navigation.NavigateTo("/")' />
        }
        else{
            <MudImage Src="icons/badreview/logo_full_256x256.png" Alt="BadReview Logo Dark" Height="45"
            Class="mr-6 mud-elevation-hover" Style="cursor: pointer;" @onclick='() => Navigation.NavigateTo("/")' />
        }

        <!--<MudMenu Icon="@Icons.Material.Filled.MoreVert" Color="Color.Inherit" AriaLabel="Open user menu" >
        
            <MudMenuItem OnClick="DarkModeToogle" AutoClose="false">
                <MudStack Row="true" AlignItems="AlignItems.Center" Spacing="1">
                    <MudText Typo=Typo.body2>Dark Mode</MudText>
                    <MudSwitch @bind-Value="_isDarkMode" ReadOnly="true" Color="Color.Primary"
                        T="bool" Size="Size.Medium"
                        ThumbIcon="@(_isDarkMode==true ? Icons.Material.Outlined.DarkMode : Icons.Material.Outlined.WbSunny)"
                        ThumbIconColor="@(_isDarkMode==true ? Color.Info : Color.Error)"/>
                </MudStack>
            </MudMenuItem>
            
        </MudMenu>-->
    </MudAppBar>
    <MudDrawer Color=Color.Primary @bind-Open="@_drawerOpen" Fixed="true" Variant="@DrawerVariant.Mini" OpenMiniOnHover="true">
        <NavMenu/>
    </MudDrawer>
    <MudMainContent Style="display: flex; flex-direction: column; min-height: 100vh;">
        <MudContainer Class="pa-8" MaxWidth="MaxWidth.Large" Style="flex: 1;">
            <CascadingValue Value="_provider">
                <CascadingValue Value="AuthService">
                    <CascadingValue Value="_isDarkMode" Name="IsDarkMode">
                        @Body
                    </CascadingValue>
                </CascadingValue>
            </CascadingValue>
        </MudContainer>
        <Footer />
    </MudMainContent>
</MudLayout>

<!--
<CustomDialog @ref="confirmLogout"
              Title="Log out"
              Icon="@Icons.Material.Filled.Logout"
              OnConfirm="LogoutAsync">
    <MudText> Are you sure you wish to log out? </MudText>
</CustomDialog>
-->
@code {
    private string _searchText = string.Empty;

    //CustomDialog? confirmLogout;

    private async Task<IEnumerable<BasicGameDto>> OnSearchGames(string searchText)
    {    
        ApiRequest apiRequest = new ApiRequest{
            URI = APIUTILS.URIS.GAMES, 
            PageSize = 30,
            OrderBy = "total_rating_count",
            Order = SortOrder.DSC,
            Page = 0 };

        if (string.IsNullOrWhiteSpace(searchText))
        {
            // Retornar todos los juegos
            var allGames = await ApiService.GetManyAsync<BasicGameDto>(apiRequest);
            return allGames?.Data ?? Enumerable.Empty<BasicGameDto>();
        }
        apiRequest.Filters = $"@name ~ *\"{searchText}\"*";
        PagedResult<BasicGameDto>? responseDto = await ApiService.GetManyAsync<BasicGameDto>(apiRequest);
        if (responseDto != null)
        {
            return responseDto?.Data ?? Enumerable.Empty<BasicGameDto>();
        }
        return Enumerable.Empty<BasicGameDto>();
    }
    private void OnDropdownSelected(BasicGameDto game){
        Navigation.NavigateTo($"/game/{game.Id}");
    }
    [CascadingParameter]
    Task<AuthenticationState> authStateTask { get; set; } = null!;
    AuthenticationState authState = null!;
    JWTAuthStateProvider stateProvider = null!;

 //   private MudTheme _theme = new MudTheme();

    private MudTheme _theme = new MudTheme()
    {
        PaletteDark = new PaletteDark()
        {
        PrimaryDarken = "#27272F",
        Primary = "rgba(255,255,255, 0.2)",
        InfoLighten = Colors.Green.Default,
        InfoDarken = Colors.Red.Default
        },
        PaletteLight = new PaletteLight()
        {
        Background = "#FBFEF9",
        InfoLighten = Colors.Green.Default,
        InfoDarken = Colors.Red.Default
        }
    };
    public bool _isDarkMode;

    public bool DarkMode = true;
    bool _drawerOpen = true;
    bool disableDarkModeToggle = false;

    async Task DarkModeToogle() {
        if (!disableDarkModeToggle)
        {
            _isDarkMode = !_isDarkMode;
            await js.InvokeVoidAsync("localStorage.setItem", "isDarkMode", _isDarkMode);
            Console.WriteLine("DarkModeToogle");
            disableDarkModeToggle = true;
            await Task.Delay(500);
            disableDarkModeToggle = false;
        }
    }

    void DrawerToggle() => _drawerOpen = !_drawerOpen;

    /*private async void LogoutAsync()
    {
        ShowSnackbar("Logged out, reloading the page ...", Severity.Info);
        await AuthService.LogoutAsync(stateProvider); 
        await Task.Delay(500);
        Navigation.Refresh();

        void ShowSnackbar(string msg, Severity severity)
        {
            Snackbar.Configuration.PositionClass = Defaults.Classes.Position.BottomCenter;
            var config = (SnackbarOptions options) =>
            {
                options.DuplicatesBehavior = SnackbarDuplicatesBehavior.Prevent;
                options.VisibleStateDuration = 2000;
                options.HideTransitionDuration = 750;
                options.ShowTransitionDuration = 500;
                options.CloseAfterNavigation = false;
                options.IconSize = Size.Large;
                options.ShowCloseIcon = false;
            };
            Snackbar.Add(msg, severity, config);
            Snackbar.Configuration.PositionClass = Defaults.Classes.Position.BottomStart;
        }
    }*/

    private void LogToken() => AuthService.LogJWToken(authState, Logger); 

    protected override async Task OnInitializedAsync()
    {
        authState = await authStateTask!;
        stateProvider = (JWTAuthStateProvider)_provider;
        try{
            var darkModeValue = await js.InvokeAsync<string>("localStorage.getItem", "isDarkMode");
            _isDarkMode = darkModeValue == "true";
        }
        catch{
             _isDarkMode = false;
        }

    }
}