@using System.Threading.Tasks
@using BadReview.Shared.DTOs.Request
@inherits LayoutComponentBase
@* Required *@
<MudThemeProvider @bind-IsDarkMode="@_isDarkMode" Theme="_theme"/>
<MudPopoverProvider />

@* Needed for dialogs *@
<MudDialogProvider />

@* Needed for snackbars *@
<MudSnackbarProvider />

@inject HttpClient Client
@inject ILogger<MainLayout> Logger
@inject AuthService AuthService
@inject AuthenticationStateProvider _provider

<MudLayout>
    <MudAppBar>
        <MudIconButton Icon="@Icons.Material.Filled.Menu" Color="Color.Inherit" Edge="Edge.Start" OnClick="DrawerToggle" />

        <CustomFilter @bind-Value="_searchText" OnSearchAsync="OnSearchAsync" Placeholder="Search for games..." />

        <MudSpacer />
        <MudText Typo="Typo.h5" Style="font-family: 'Montserrat', 'Helvetica', sans-serif; font-weight: 700; letter-spacing: 1px;">
            BadReview
        </MudText>
        <MudSpacer />
        

        <MudMenu Icon="@Icons.Material.Filled.MoreVert" Color="Color.Inherit" AriaLabel="Open user menu" Dense="true">
            <AuthorizeView>
                <Authorized>
                    <MudMenuItem OnClick="LogToken" Label="Profile"/>
                    <MudMenuItem Label="My account"/>
                    <MudMenuItem OnClick="LogoutAsync" Label="Log out"/>
                </Authorized>
                <NotAuthorized>
                    <MudMenuItem Href="/login" Label="Log in" />
                </NotAuthorized>
            </AuthorizeView>


            <MudDivider></MudDivider>

            <MudMenuItem OnClick="DarkModeToogle" AutoClose="false">
                <MudStack Row="true" AlignItems="AlignItems.Center" Spacing="1">
                    <MudText Typo=Typo.body2>Dark Mode</MudText>
                    <MudSwitch @bind-Value="_isDarkMode" ReadOnly="true" Color="Color.Primary"
                        T="bool" Size="Size.Medium"
                        ThumbIcon="@(_isDarkMode==true ? Icons.Material.Outlined.DarkMode : Icons.Material.Outlined.WbSunny)"
                        ThumbIconColor="@(_isDarkMode==true ? Color.Info : Color.Error)"/>
                </MudStack>
            </MudMenuItem>
        </MudMenu>

    </MudAppBar>
    <MudDrawer @bind-Open="@_drawerOpen" Fixed="true" Variant="@DrawerVariant.Mini" OpenMiniOnHover="true">
        <NavMenu/>
    </MudDrawer>
    <MudMainContent>
        <MudContainer Class="pa-8" MaxWidth="MaxWidth.Large">
            <CascadingValue Value="_provider">
                <CascadingValue Value="AuthService">
                    @Body
                </CascadingValue>
            </CascadingValue>
        </MudContainer>
    </MudMainContent>
</MudLayout>

@code {
    private string _searchText = string.Empty;

    private void OnSearchAsync(string searchText)
    {
        Console.WriteLine($"Searching for: {searchText}");
        // You can implement additional logic here if needed
    }

    [CascadingParameter]
    Task<AuthenticationState>? authStateTask { get; set; }
    AuthenticationState authState = null!;
    JWTAuthStateProvider stateProvider = null!;

    private MudTheme _theme = new MudTheme();
    private bool _isDarkMode;
    bool _drawerOpen = true;
    bool disableDarkModeToggle = false;

    async Task DarkModeToogle() {
        if (!disableDarkModeToggle)
        {
            _isDarkMode = !_isDarkMode;
            Console.WriteLine("DarkModeToogle");
            disableDarkModeToggle = true;
            await Task.Delay(500);
            disableDarkModeToggle = false;
        }
    }

    void DrawerToggle() => _drawerOpen = !_drawerOpen;

    //private async void LoginAsync() => await AuthService.LoginAsync(stateProvider,"lauti", "hola123"); 

    private async void LogoutAsync() => await AuthService.LogoutAsync(stateProvider); 

    private void LogToken() => AuthService.LogJWToken(authState, Logger); 

    protected override async Task OnInitializedAsync()
    {
        authState = await authStateTask!;
        stateProvider = (JWTAuthStateProvider)_provider;
    }
}