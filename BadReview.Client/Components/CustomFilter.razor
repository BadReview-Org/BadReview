@using BadReview.Shared.DTOs.Response
@using MudBlazor.Charts
@inject NavigationManager Navigation
<MudStack Spacing="2">
    <MudStack Spacing="2" Row="true" AlignItems="AlignItems.Center">
        <MudTextField Class="flex-grow-1 mx-4" @bind-Value="Value" 
                        Placeholder="@Placeholder" 
                        Adornment="Adornment.Start" 
                        AdornmentIcon="@Icons.Material.Filled.Search"
                        Variant="Variant.Outlined"
                        Immediate="true"
                        DebounceInterval="500"
                        OnDebounceIntervalElapsed="OnSearchAsyncInternal"
                        Margin="Margin.Dense"
                        OnBlur="async () => { if (Value != lastSearched) await OnSearchAsyncInternal(Value); }"/>

        @if (SetChips)
        {   
            <MudButton Variant="Variant.Text"
                    Color="Color.Primary"
                    Class="mud-typography mud-typography-h6 text-button"
                    OnClick="() => _openEnd = true">
                Open Filters
            </MudButton>    
        }
    </MudStack>
    <MudStack Spacing="2" Row="true" AlignItems="AlignItems.Center">
        @if(SelectedGenre != null && !_openEnd){
        <MudChip T="string" Color="Color.Primary" Variant="Variant.Filled" Class="mx-1">
            <strong>Genre: </strong> @SelectedGenre.Name
            <MudIconButton Icon="@Icons.Material.Filled.Close" Size="Size.Small" Color="Color.Inherit" OnClick="async () => {SelectedGenre = null; await OnClickApplyFilters();}" Class="ml-1" />
        </MudChip>
        }
        @if(SelectedPlatform != null && !_openEnd){
        <MudChip T="string" Color="Color.Primary" Variant="Variant.Filled" Class="mx-1">
            <strong>Platform: </strong> @SelectedPlatform.Name
            <MudIconButton Icon="@Icons.Material.Filled.Close" Size="Size.Small" Color="Color.Inherit" OnClick="async () => {SelectedPlatform = null; await OnClickApplyFilters();}" Class="ml-1" />
        </MudChip>
        }
        @if(SelectedDeveloper != null && !_openEnd){
        <MudChip T="string" Color="Color.Primary" Variant="Variant.Filled" Class="mx-1">
            <strong>Developer: </strong> @SelectedDeveloper.Name
            <MudIconButton Icon="@Icons.Material.Filled.Close" Size="Size.Small" Color="Color.Inherit" OnClick="async () => {SelectedDeveloper = null; await OnClickApplyFilters();}" Class="ml-1" />
        </MudChip>
        }
        @if(HasRatingFilter && !_openEnd){
        <MudChip T="string" Color="Color.Primary" Variant="Variant.Filled" Class="mx-1">
            <strong>IGDB Rating: </strong> @MinRating.ToString("F1") - @MaxRating.ToString("F1")
            <MudIconButton Icon="@Icons.Material.Filled.Close" Size="Size.Small" Color="Color.Inherit" OnClick="async () => {MinRating = 0; MaxRating = 10; await OnClickApplyFilters();}" Class="ml-1" />
        </MudChip>
        }
    </MudStack>
</MudStack>
<!-- Addtional Filters Drawer -->
<MudDrawer OverlayAutoClose="false" @bind-Open="@_openEnd" Width="350px" Fixed="true" Anchor="Anchor.End" Elevation="0" Variant="@DrawerVariant.Temporary">
    <MudDrawerHeader>
        <MudText Typo="Typo.h6">Filter</MudText>
    </MudDrawerHeader>
    <MudStack Spacing="3" Class="mt-2 px-4">
        <MudStack Spacing="2">
            <MudText Typo="Typo.subtitle1" Class="fw-bold">Platform</MudText>
            <CustomDropdown T="PlatformDto" 
                                Label="Name" 
                                DropdownChanged="@(platform => SelectedPlatform = platform)"
                                SearchElements="@OnSearchPlatforms"
                                MinChars="3"
                                ToStringFunc="@(platform => platform?.Name ?? "")"
                                Value="@SelectedPlatform"
                                >
                <ItemTemplate Context="platform">
                    <MudStack Row ="true" AlignItems="AlignItems.Center" Spacing="2" >
                        <MudImage Src="@ImageHelper.GetCoverUrl(platform.LogoId)" 
                                    Alt="" 
                                    Style="height: 50px; width: 50px; margin-bottom: 10px;" />
                        <MudText Typo="Typo.subtitle1" Align="Align.Left" Style="color: white;">
                            @platform.Name
                        </MudText>
                    </MudStack>
                </ItemTemplate>
            </CustomDropdown>
        </MudStack>

        <MudDivider />

        <MudStack Spacing="2">
            <MudText Typo="Typo.subtitle1" Class="fw-bold">Genre</MudText>
            <CustomDropdown T="GenreDto" 
                                Label="Name"
                                DropdownChanged="@(genre => SelectedGenre = genre)"
                                SearchElements="@OnSearchGenres"
                                ToStringFunc="@(genre => genre?.Name ?? "")"
                                Value="@SelectedGenre"
                                MinChars="1"
                                >
                <ItemTemplate Context="genre">
                    <MudStack Row ="true" AlignItems="AlignItems.Center" Spacing="2" >
                        <MudIcon Icon="@IconsMap.GenreIcon[(IconsMap.Genres)genre.Id]" 
                            Size="Size.Large" 
                            Style="color: white;" />
                        <MudText Typo="Typo.subtitle1" Align="Align.Left" Style="color: white;">
                            @genre.Name
                        </MudText>
                    </MudStack>
                </ItemTemplate>
            </CustomDropdown>
        </MudStack>
            <MudDivider />

        <MudStack Spacing="2">
            <MudText Typo="Typo.subtitle1" Class="fw-bold">Developers</MudText>
            <CustomDropdown T="BasicDeveloperDto" 
                                Label="Name" 
                                DropdownChanged="@(developer => SelectedDeveloper = developer)"
                                SearchElements="@OnSearchDevelopers"
                                MinChars="3"
                                ToStringFunc="@(dev => dev?.Name ?? "")"
                                Value="@SelectedDeveloper"
                                >
                <ItemTemplate Context="dev">
                    <MudStack Row ="true" AlignItems="AlignItems.Center" Spacing="2" >
                        <MudImage Src="@ImageHelper.GetCoverUrl(dev.LogoId)" 
                                    Alt="" 
                                    Style="height: 50px; width: 50px; margin-bottom: 10px;" />
                        <MudText Typo="Typo.subtitle1" Align="Align.Left" Style="color: white;">
                            @dev.Name
                        </MudText>
                    </MudStack>
                </ItemTemplate>
            </CustomDropdown>

        </MudStack>

        <MudDivider />

        <MudStack Spacing="2">
            <MudText Typo="Typo.subtitle1" Class="fw-bold">IGDB Rating Range</MudText>
            <MudStack Spacing="1">
                <MudText Typo="Typo.body2">Minimum: @MinRating.ToString("F1")</MudText>
                <MudSlider T="double" 
                           Value="MinRating" 
                           Min="0" 
                           Max="10" 
                           Step="0.1" 
                           Color="Color.Primary"
                           ValueChanged="@OnMinRatingChanged" />

                <MudText Typo="Typo.body2" Class="mt-2">Maximum: @MaxRating.ToString("F1")</MudText>
                <MudSlider T="double" 
                           Value="MaxRating" 
                           Min="0" 
                           Max="10" 
                           Step="0.1" 
                           Color="Color.Primary"
                           ValueChanged="@OnMaxRatingChanged" />
            </MudStack>
        </MudStack>
        
        <MudStack row="true" Justify="Justify.Center" AlignItems="AlignItems.Center">
            <MudButton Variant="Variant.Filled" Color="Color.Primary" OnClick="OnClickApplyFilters" Class="mt-4 mx-4">
                Apply Filters
            </MudButton>
            <MudButton Variant="Variant.Filled" Color="Color.Secondary" OnClick="OnClickCancel" Class="mt-4 mx-4">
                Cancel
            </MudButton>
        </MudStack>
    </MudStack>
</MudDrawer>


@code {
    //--------------- Private variables ----------------

    private bool _openEnd = false;

    private PlatformDto? SelectedPlatform { get; set; }
    private GenreDto? SelectedGenre { get; set; }
    
    private BasicDeveloperDto? SelectedDeveloper { get; set; }
    
    private double MinRating { get; set; } = 0;
    private double MaxRating { get; set; } = 10;
    
    private bool HasRatingFilter => MinRating > 0 || MaxRating < 10;

    private string lastSearched = "";

    //--------------- Public Parameters ----------------
    // Dropdown 
    [Parameter] public bool Dropdown {get; set; } = true;

    [Parameter] public List<PlatformDto> Platforms { get; set; } = new();
    [Parameter] public List<GenreDto> Genres { get; set; } = new();

    [Parameter] public List<BasicDeveloperDto> Developers { get; set; } = new();
    [Parameter] public string? SelectedFilter { get; set; } = "released";

    [Parameter] public string? extraFilters { get; set; } = "";
    [Parameter] public string Value { get; set; } = string.Empty;
    [Parameter] public string? Placeholder { get; set; } = "Search...";

    [Parameter] public bool SetChips { get; set; } = false;
    //--------------- Bind callbacks ----------------
    [Parameter] public EventCallback<string> ValueChanged { get; set; }

    [Parameter] public EventCallback<string> SelectedFilterChanged { get; set; }

    [Parameter] public EventCallback<string> extraFiltersChanged {get; set;}

    //--------------- Public callbacks parameters ----------------

    [Parameter] public EventCallback<string> OnSearchAsync { get; set; }

    [Parameter] public Func<string, Task<IEnumerable<GenreDto>>>? SearchGenres { get; set; }

    [Parameter] public Func<string, Task<IEnumerable<PlatformDto>>>? SearchPlatforms { get; set; }

    [Parameter] public Func<string, Task<IEnumerable<BasicDeveloperDto>>>? SearchDevelopers { get; set; }

    [Parameter] public EventCallback<string> ClickApplyFilters { get; set; }

    private async Task OnClickCancel()
    {
        _openEnd = false;
        SelectedDeveloper = null;
        SelectedGenre = null;
        SelectedPlatform = null;
        MinRating = 0;
        MaxRating = 10;
        
        extraFilters = "";
        await extraFiltersChanged.InvokeAsync(extraFilters);
        StateHasChanged();

        await OnSearchAsyncInternal(Value);
    }
    
    private void OnMinRatingChanged(double value)
    {
        MinRating = value;
        if (MinRating > MaxRating)
        {
            MaxRating = MinRating;
        }
    }
    
    private void OnMaxRatingChanged(double value)
    {
        MaxRating = value;
        if (MaxRating < MinRating)
        {
            MinRating = MaxRating;
        }
    }
    
    [CascadingParameter(Name = "IsDarkMode")]
    public bool isDarkMode { get; set; }
    // Platform and Genre specific filters
    
    
//    [Parameter] public EventCallback<PlatformDto?> OnPlatformChanged { get; set; }
//    [Parameter] public EventCallback<GenreDto?> OnGenreChanged { get; set; }


    private async Task OnSelectedFilterChangedInternal(string value)
    {
        SelectedFilter = value;
        await SelectedFilterChanged.InvokeAsync(value);
    }

    private async Task OnClickApplyFilters()
    {
        _openEnd = false;
        List<string>? param = new List<string>();
        if(SelectedGenre?.Id != null)
            param.Add($"genres = [{SelectedGenre?.Id}]");
        if(SelectedPlatform?.Id != null)
            param.Add($"platforms = [{SelectedPlatform?.Id}]");
        if(SelectedDeveloper?.Id != null)
            param.Add($"involved_companies.company = {SelectedDeveloper?.Id}&involved_companies.developer = true");
        if(HasRatingFilter)
            param.Add($"rating >= {MinRating*10} & rating <= {MaxRating*10}");
        string query = string.Join('&',param);
        
        extraFilters = query;
        await extraFiltersChanged.InvokeAsync(query);
        await ClickApplyFilters.InvokeAsync(query);
    }

    private async Task OnSearchAsyncInternal(string value)
    {
        Value = value;
        lastSearched = value;
        await ValueChanged.InvokeAsync(value);
        if (OnSearchAsync.HasDelegate)
        {
            await OnSearchAsync.InvokeAsync(value);
        }
    }

    private async Task<IEnumerable<PlatformDto>> OnSearchPlatforms(string value)
    {
        // Si hay un callback definido, se busca en la API
        if (SearchPlatforms != null)
        {
            var platforms = await SearchPlatforms(value);
            return platforms ?? Enumerable.Empty<PlatformDto>();
        }
        
        // Fallback: búsqueda local si no hay callback
        if (string.IsNullOrWhiteSpace(value))
            return Platforms;

        return Platforms.Where(p => p.Name.Contains(value, StringComparison.OrdinalIgnoreCase));
    }

    private async Task<IEnumerable<GenreDto>> OnSearchGenres(string value)
    {
        // Si hay un callback definido, se busca en la API
        if (SearchGenres != null)
        {
            var genres = await SearchGenres(value);
            return genres ?? Enumerable.Empty<GenreDto>();
        }
        
        // Fallback: búsqueda local si no hay callback
        if (string.IsNullOrWhiteSpace(value))
            return Genres;
            
        return Genres.Where(g => g.Name.Contains(value, StringComparison.OrdinalIgnoreCase));
    }

    private async Task<IEnumerable<BasicDeveloperDto>> OnSearchDevelopers(string value)
    {
        // Si hay un callback definido, se busca en la API
        if (SearchDevelopers != null)
        {
            var developers = await SearchDevelopers(value);
            return developers ?? Enumerable.Empty<BasicDeveloperDto>();
        }
        
        // Fallback: búsqueda local si no hay callback
        if (string.IsNullOrWhiteSpace(value))
            return Developers;
            
        return Developers.Where(g => g.Name.Contains(value, StringComparison.OrdinalIgnoreCase));
    }
}
