@using BadReview.Shared.DTOs.Response

@inject NavigationManager Navigation

@if(Dropdown){
<MudAutocomplete T="BasicGameDto" 
                            Label="Game Name" 
                            Value="SelectedGame"
                            SearchFunc="@OnSearchGames"
                            ToStringFunc="@(g => g?.Name ?? "")"
                            Variant="Variant.Outlined"
                            Margin="Margin.Dense"
                            AdornmentIcon="@Icons.Material.Filled.Search"
                            Adornment="Adornment.Start"
                            Clearable="true"
                            ValueChanged ="OnValueChanged"
                             >
    <ItemTemplate Context="game">
        <MudStack Row="true" AlignItems="AlignItems.Center" Spacing="2">
            <img src="@ImageHelper.GetCoverUrl(game.CoverId)" 
                 style="width: auto; height: 60px; object-fit: cover; border-radius: 4px;" />
            <MudStack Spacing="1">
                <MudText Typo="Typo.subtitle1">@game.Name</MudText>
                <MudStack Row="true" AlignItems="AlignItems.Center" Spacing="2">
                    <img src="IGDB_logo-white.svg.png" alt="IGDB" style="height: 14px; width: auto; opacity: 0.8;" />
                    <MudText Typo="Typo.subtitle2">@(((double)(game?.RatingIGDB ?? 0) / 10).ToString("F1", System.Globalization.CultureInfo.InvariantCulture))</MudText>
                </MudStack>
            </MudStack>
        </MudStack>
    </ItemTemplate>
    
</MudAutocomplete>

}
else{
<MudTextField Class="flex-grow-1 mx-4" @bind-Value="Value" 
                Placeholder="@Placeholder" 
                Adornment="Adornment.Start" 
                AdornmentIcon="@Icons.Material.Filled.Search"
                Variant="Variant.Outlined"
                Immediate="true"
                DebounceInterval="500"
                OnDebounceIntervalElapsed="OnSearchAsyncInternal"
                Margin="Margin.Dense"
                    />
}
@if (SetChips)
{   
    <MudButton Variant="Variant.Text"
            Color="Color.Primary"
            Class="mud-typography mud-typography-h6 text-button"
            OnClick="() => _openEnd = true">
        Abrir men√∫
    </MudButton>    
}

<MudDrawer @bind-Open="@_openEnd" Width="350px" Fixed="true" Anchor="Anchor.End" Elevation="0" Variant="@DrawerVariant.Temporary">
    <MudDrawerHeader>
        <MudText Typo="Typo.h6">Filter</MudText>
    </MudDrawerHeader>
    <MudStack Spacing="3" Class="mt-2 px-4">
        <MudChipSet SelectedValue="@SelectedFilter" 
                    SelectedValueChanged="@OnSelectedFilterChangedInternal"
                    T="string" 
                    CheckMark="true" 
                    SelectionMode="@SelectionMode.SingleSelection">
            <MudChip Text="Released" Size="Size.Small" Color="Color.Primary" Value="@("released")">Released</MudChip>
            <MudChip Text="TBA" Size="Size.Small" Color="Color.Primary" Value="@("tba")">TBA</MudChip>
    </MudChipSet>
    
    <MudDivider />
       
    <MudStack Spacing="2">
        <MudText Typo="Typo.subtitle1" Class="fw-bold">Platform</MudText>
        <MudAutocomplete T="PlatformDto" 
                            Label="Name" 
                            Value="@SelectedPlatform"
                            SearchFunc="@OnSearchPlatforms"
                            ToStringFunc="@(p => p?.Name ?? "")"
                            Variant="Variant.Outlined"
                            Margin="Margin.Dense"
                            AdornmentIcon="@Icons.Material.Filled.Search"
                            Adornment="Adornment.Start"
                            Clearable="true"
                            ValueChanged="@(platform => SelectedPlatform = platform)"
                            />
    </MudStack>

    <MudDivider />

    <MudStack Spacing="2">
        <MudText Typo="Typo.subtitle1" Class="fw-bold">Genre</MudText>
        <MudAutocomplete T="GenreDto" 
                            Label="Name" 
                            Value="@SelectedGenre"
                            SearchFunc="@OnSearchGenres"
                            ToStringFunc="@(g => g?.Name ?? "")"
                            Variant="Variant.Outlined"
                            Margin="Margin.Dense"
                            AdornmentIcon="@Icons.Material.Filled.Search"
                            Adornment="Adornment.Start"
                            Clearable="true"
                            ValueChanged="@(genre => SelectedGenre = genre)"
                             />
    </MudStack>
        <MudDivider />

    <MudStack Spacing="2">
        <MudText Typo="Typo.subtitle1" Class="fw-bold">Developers</MudText>
        <MudAutocomplete T="BasicDeveloperDto" 
                            Label="Name" 
                            Value="@SelectedDeveloper"
                            SearchFunc="@OnSearchDevelopers"
                            ToStringFunc="@(g => g?.Name ?? "")"
                            Variant="Variant.Outlined"
                            Margin="Margin.Dense"
                            AdornmentIcon="@Icons.Material.Filled.Search"
                            Adornment="Adornment.Start"
                            Clearable="true"
                            ValueChanged="@(developer => SelectedDeveloper = developer)"
                             />
    </MudStack>
    <MudButton Variant="Variant.Filled" Color="Color.Primary" OnClick="OnClickApplyFilters" Class="mt-4 mx-4">
       Apply Filters
    </MudButton>
    </MudStack>
</MudDrawer>


@code {
    //--------------- Private variables ----------------

    private bool _openEnd = false;

    private PlatformDto? SelectedPlatform { get; set; }
    private GenreDto? SelectedGenre { get; set; }

    private BasicGameDto? SelectedGame { get; set; }

    private BasicDeveloperDto? SelectedDeveloper { get; set; }
    //--------------- Public Parameters ----------------

    [Parameter] public bool Dropdown {get; set; } = true;

    [Parameter] public List<PlatformDto> Platforms { get; set; } = new();
    [Parameter] public List<GenreDto> Genres { get; set; } = new();

    [Parameter] public List<BasicDeveloperDto> Developers { get; set; } = new();
    [Parameter] public string? SelectedFilter { get; set; } = "released";

    [Parameter] public string? extraFilters { get; set; } = "";
    [Parameter] public string Value { get; set; } = string.Empty;
    [Parameter] public string? Placeholder { get; set; } = "Search...";

    [Parameter] public bool SetChips { get; set; } = false;
    //--------------- Bind callbacks ----------------
    [Parameter] public EventCallback<string> ValueChanged { get; set; }

    [Parameter] public EventCallback<string> SelectedFilterChanged { get; set; }

    [Parameter] public EventCallback<string> extraFiltersChanged {get; set;}

    //--------------- Public callbacks parameters ----------------

    [Parameter] public EventCallback<string> OnSearchAsync { get; set; }

    [Parameter] public Func<string, Task<IEnumerable<BasicGameDto>>>? SearchGames { get; set; }

    [Parameter] public Func<string, Task<IEnumerable<GenreDto>>>? SearchGenres { get; set; }

    [Parameter] public Func<string, Task<IEnumerable<PlatformDto>>>? SearchPlatforms { get; set; }

    [Parameter] public Func<string, Task<IEnumerable<BasicDeveloperDto>>>? SearchDevelopers { get; set; }

    [Parameter] public EventCallback<string> ClickApplyFilters { get; set; }
    
    // Platform and Genre specific filters
    
    
//    [Parameter] public EventCallback<PlatformDto?> OnPlatformChanged { get; set; }
//    [Parameter] public EventCallback<GenreDto?> OnGenreChanged { get; set; }

    private void OnValueChanged(BasicGameDto game){
        SelectedGame = null;
        Navigation.NavigateTo($"/game/{game.Id}");
    }

    private async Task<IEnumerable<BasicGameDto>> OnSearchGames(string value, CancellationToken token)
    {
        Console.WriteLine($"üîç OnSearchGames llamado con: '{value}'");
 
        // Si hay un callback definido, se busca en la API
        if (SearchGames != null)
        {
            var games = await SearchGames(value);
            return games ?? Enumerable.Empty<BasicGameDto>();
        }
        

        return Enumerable.Empty<BasicGameDto>();
    }
    private async Task OnSelectedFilterChangedInternal(string value)
    {
        SelectedFilter = value;
        await SelectedFilterChanged.InvokeAsync(value);
    }

    private async Task OnClickApplyFilters()
    {
        _openEnd = false;
        List<string>? param = new List<string>();
        if(SelectedGenre?.Id != null)
            param.Add($"genres = {SelectedGenre?.Id}");
        if(SelectedPlatform?.Id != null)
            param.Add($"platforms = {SelectedPlatform?.Id}");
        if(SelectedDeveloper?.Id != null)
            param.Add($"involved_companies.company = {SelectedDeveloper?.Id}&involved_companies.developer = true");
        string query = string.Join('&',param);
        
        extraFilters = query;
        await extraFiltersChanged.InvokeAsync(query);
        await ClickApplyFilters.InvokeAsync(query);
    }

    private async Task OnSearchAsyncInternal(string value)
    {
        Value = value;
        await ValueChanged.InvokeAsync(value);
        if (OnSearchAsync.HasDelegate)
        {
            await OnSearchAsync.InvokeAsync(value);
        }
    }

    private async Task<IEnumerable<PlatformDto>> OnSearchPlatforms(string value, CancellationToken token)
    {
        // Si hay un callback definido, se busca en la API
        if (SearchPlatforms != null)
        {
            var platforms = await SearchPlatforms(value);
            return platforms ?? Enumerable.Empty<PlatformDto>();
        }
        
        // Fallback: b√∫squeda local si no hay callback
        if (string.IsNullOrWhiteSpace(value))
            return Platforms;

        return Platforms.Where(p => p.Name.Contains(value, StringComparison.OrdinalIgnoreCase));
    }

    private async Task<IEnumerable<GenreDto>> OnSearchGenres(string value, CancellationToken token)
    {
        // Si hay un callback definido, se busca en la API
        if (SearchGenres != null)
        {
            var genres = await SearchGenres(value);
            return genres ?? Enumerable.Empty<GenreDto>();
        }
        
        // Fallback: b√∫squeda local si no hay callback
        if (string.IsNullOrWhiteSpace(value))
            return Genres;
            
        return Genres.Where(g => g.Name.Contains(value, StringComparison.OrdinalIgnoreCase));
    }

    private async Task<IEnumerable<BasicDeveloperDto>> OnSearchDevelopers(string value, CancellationToken token)
    {
        // Si hay un callback definido, se busca en la API
        if (SearchDevelopers != null)
        {
            var developers = await SearchDevelopers(value);
            return developers ?? Enumerable.Empty<BasicDeveloperDto>();
        }
        
        // Fallback: b√∫squeda local si no hay callback
        if (string.IsNullOrWhiteSpace(value))
            return Developers;
            
        return Developers.Where(g => g.Name.Contains(value, StringComparison.OrdinalIgnoreCase));
    }

        /*// Fallback: b√∫squeda local si no hay callback
        if (string.IsNullOrWhiteSpace(value))
            return Developers;
            
        return Developers.Where(g => g.Name.Contains(value, StringComparison.OrdinalIgnoreCase));
       
    }
/*    
    private async Task OnPlatformSelected(PlatformDto? platform)
    {
        SelectedPlatform = platform;
        if (OnPlatformChanged.HasDelegate)
        {
            await OnPlatformChanged.InvokeAsync(platform);
        }
    }
 */ 
/*  
    private async Task OnGenreSelected(GenreDto? genre)
    {
        SelectedGenre = genre;
        if (OnGenreChanged.HasDelegate)
        {
            await OnGenreChanged.InvokeAsync(genre);
        }
    }
    */
}
