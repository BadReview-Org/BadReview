@using System.Globalization
@using BadReview.Client.Services
@using BadReview.Shared.DTOs.Response
@using BadReview.Shared.DTOs.Request
@using BadReview.Shared.Utils
@using BadReview.Client.Utils
@using MudBlazor

@inject ApiService ApiService
@inject ICountriesIso countriesMap
@inject ValidatorRules.ICheckAvailables checkAvailables
@inject HttpClient Client

@if (user == null)
{
    <MudContainer MaxWidth="MaxWidth.Large" Class="mt-6">
        <MudGrid Spacing="4">
            <MudItem xs="12" md="4">
                <MudSkeleton SkeletonType="SkeletonType.Rectangle" Height="400px" />
            </MudItem>
            <MudItem xs="12" md="8">
                <MudSkeleton SkeletonType="SkeletonType.Rectangle" Height="150px" Class="mb-4" />
                <MudSkeleton SkeletonType="SkeletonType.Rectangle" Height="200px" />
            </MudItem>
        </MudGrid>
    </MudContainer>
}
else
{
    <MudContainer MaxWidth="MaxWidth.Large" Class="mt-6">
        <MudGrid Spacing="4">
            <!-- Header con información del usuario -->
            <MudItem xs="12">
                    <MudPaper Class="pa-6" Elevation="8" Style="background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); border-radius: 12px;">
                        <MudStack Row="true" AlignItems="AlignItems.Center" Justify="Justify.SpaceBetween" Spacing="4">
                            <MudStack Row="true" AlignItems="AlignItems.Center" Spacing="4">
                                <MudAvatar Size="Size.Large" Style="width: 100px; height: 100px; font-size: 2.5rem; background-color: rgba(255,255,255,0.2);">
                                    @user.Username[0].ToString().ToUpper()
                                </MudAvatar>
                                <MudStack Spacing="1">
                                    <MudText Typo="Typo.h3" Style="font-weight: 700; color: white;">
                                        @user.Username
                                    </MudText>
                                    @if (IsPrivateProfile && !string.IsNullOrEmpty(AsPrivate?.FullName))
                                    {
                                        <MudText Typo="Typo.h6" Style="color: rgba(255,255,255,0.9);">
                                            @AsPrivate.FullName
                                        </MudText>
                                    }
                                    <MudText Typo="Typo.body2" Style="color: rgba(255,255,255,0.8);">
                                        Member since @user.CreatedAt.ToString("MMMM yyyy", CultureInfo.InvariantCulture)
                                    </MudText>
                                </MudStack>
                            </MudStack>
                            @if(IsPrivateProfile)
                            {
                                <MudCollapse Expanded="!showSettings">
                                    <MudIconButton Icon="@Icons.Material.Filled.Settings" 
                                        Style="color: white" Size="Size.Large" OnClick="() => showSettings = !showSettings"/>
                                </MudCollapse>
                            }
                        </MudStack>
                    </MudPaper>
                </MudItem>
            @if(!showSettings)
            {
            <!-- Columna Izquierda - Información Personal -->
            <MudItem xs="12" md="4">
                <MudStack Spacing="3">
                    <!-- Personal Info Card -->
                    <MudPaper Class="pa-4" Elevation="6" Style="background: linear-gradient(145deg, #2a2a2a, #1a1a1a);">
                        <MudStack Row="true" AlignItems="AlignItems.Center" Spacing="1" Class="mb-3">
                            <MudIcon Icon="@Icons.Material.Filled.Person" Size="Size.Medium" />
                            <MudText Typo="Typo.h6" Style="color: #667eea;">
                                Personal Information
                            </MudText>
                        </MudStack>
                        <MudStack Spacing="2">
                            <MudStack Row="true" AlignItems="AlignItems.Center" Spacing="2">
                                <MudIcon Icon="@Icons.Material.Filled.AccountCircle" Size="Size.Small" Color="Color.Primary" />
                                <MudText Typo="Typo.body2">
                                    <strong>Username:</strong> @user.Username
                                </MudText>
                            </MudStack>

                            <MudStack Row="true" AlignItems="AlignItems.Center" Spacing="2">
                                <MudIcon Icon="@Icons.Material.Filled.Flag" Size="Size.Small" Color="Color.Primary" />
                                <MudText Typo="Typo.body2">
                                    <strong>Country:</strong> @countryString
                                </MudText>
                            </MudStack>

                            @if (IsPrivateProfile && !string.IsNullOrEmpty(AsPrivate?.FullName))
                            {
                                <MudStack Row="true" AlignItems="AlignItems.Center" Spacing="2">
                                    <MudIcon Icon="@Icons.Material.Filled.Badge" Size="Size.Small" Color="Color.Primary" />
                                    <MudText Typo="Typo.body2">
                                        <strong>Full Name:</strong> @AsPrivate.FullName
                                    </MudText>
                                </MudStack>
                            }

                            @if (IsPrivateProfile && AsPrivate?.Birthday.HasValue == true)
                            {
                                <MudStack Row="true" AlignItems="AlignItems.Center" Spacing="2">
                                    <MudIcon Icon="@Icons.Material.Filled.Cake" Size="Size.Small" Color="Color.Primary" />
                                    <MudText Typo="Typo.body2">
                                        <strong>Birthday:</strong> @AsPrivate.Birthday.Value.ToString("MMMM dd, yyyy", CultureInfo.InvariantCulture)
                                    </MudText>
                                </MudStack>
                            }
                        </MudStack>
                    </MudPaper>

                    <!-- Activity Stats Card -->

                    <MudPaper Class="pa-4" Elevation="6" Style="background: linear-gradient(145deg, #2a2a2a, #1a1a1a);">
                        <MudStack Row="true" AlignItems="AlignItems.Center" Spacing="1" Class="mb-3">
                            <MudIcon Icon="@Icons.Material.Filled.BarChart" Size="Size.Medium" />
                            <MudText Typo="Typo.h6" Style="color: #764ba2;"> 
                                Activity
                            </MudText>
                        </MudStack>
                        <MudStack Spacing="2">
                            <MudStack Row="true" Justify="Justify.SpaceBetween">
                                <MudText Typo="Typo.body2">
                                    <MudIcon Icon="@Icons.Material.Filled.RateReview" Size="Size.Small" Class="mr-1" />
                                    Reviews
                                </MudText>
                                <MudChip T="string" Size="Size.Small" Color="Color.Primary">
                                    @user.Reviews.TotalCount
                                </MudChip>
                            </MudStack>
                            <MudStack Row="true" Justify="Justify.SpaceBetween">
                                <MudText Typo="Typo.body2">
                                    <MudIcon Icon="@Icons.Material.Filled.Favorite" Size="Size.Small" Class="mr-1" />
                                    Favorites
                                </MudText>
                                <MudChip T="string" Size="Size.Small" Color="Color.Error">
                                    @user.Favorites.TotalCount
                                </MudChip>
                            </MudStack>
                        </MudStack>
                    </MudPaper>
                    
                </MudStack>
            </MudItem>

            <!-- Columna Derecha - Reviews y Favorites -->
            <MudItem xs="12" md="8">
                <MudStack Spacing="3">
                    
                    <!-- Favorite Games -->
                    <MudPaper Class="pa-4" Elevation="6" Style="background: linear-gradient(145deg, #2a2a2a, #1a1a1a);">
                        <MudStack Row="true" AlignItems="AlignItems.Center" Spacing="1" Class="mb-3">
                            <MudIcon Icon="@Icons.Material.Filled.Favorite" Size="Size.Medium" Style= />
                            <MudText Typo="Typo.h5" Style="color: #764ba2;">
                                Favorite Games (@user.Favorites.TotalCount)
                            </MudText>
                        </MudStack>
                            @if (user.Favorites.Data.Any())
                        {
                            <MudStack Spacing="1">
                                <CustomGridCard pageSize="6" CardHeight="225" PageChanged="@OnPageFavoriteChanged" totalPages="totalPagesFavorite" arrayElement="favoriteGameCards" placeholderTitle="No favorite games found." placeholderBody="Add some games to your favorites!" />
                            </MudStack>
                        }
                        else
                        {
                            <MudText Typo="Typo.body2" Align="Align.Center" Style="color: #808080; padding: 40px 0;">
                                No favorite games yet. Add some favorites!
                            </MudText>
                        }
                    </MudPaper>
                    <!--  Reviews -->
                    <ReviewList  totalCount="@user.Reviews.TotalCount" totalPages="@totalPagesReviews" PageChanged="@OnPageReviewsChanged" Style="false" Reviews="userReviews" />
                </MudStack>
            </MudItem>
            }
            else{
            <!-- Settings Panel -->
            <MudItem xs="12" md="6">
                <MudPaper Class="pa-4" Elevation="6" Style="background: linear-gradient(145deg, #2a2a2a, #1a1a1a);">
                    <MudStack Row="true" AlignItems="AlignItems.Center" Spacing="1" Class="mb-3">
                        <MudIcon Icon="@Icons.Material.Filled.Settings" Size="Size.Large" Class="mr-2" />
                        
                        <MudText Typo="Typo.h5" Style="color: #764ba2;">
                            User Settings
                        </MudText>
                    </MudStack>
                    
                    <MudForm @ref="settingsForm" Model="@settingsModel" Validation="@ValidateSettings">
                        <MudStack Spacing="3" Class="mt-4">
                            <!-- Username -->
                            <MudTextField @bind-Value="settingsModel.First.Username"
                                          For="@(() => settingsModel.First.Username)"
                                          Label="Username"
                                          Variant="Variant.Outlined"
                                          Adornment="Adornment.Start"
                                          AdornmentIcon="@Icons.Material.Filled.AccountCircle" />

                            <!-- Full Name -->
                            <MudTextField @bind-Value="settingsModel.Second.FullName"
                                          For="@(() => settingsModel.Second.FullName)"
                                          Label="Full Name"
                                          Variant="Variant.Outlined"
                                          Adornment="Adornment.Start"
                                          AdornmentIcon="@Icons.Material.Filled.Badge" />

                            <!-- Email -->
                            <MudTextField @bind-Value="settingsModel.First.Email"
                                          For="@(() => settingsModel.First.Email)"
                                          Label="Email"
                                          InputType="InputType.Email"
                                          Variant="Variant.Outlined"
                                          Adornment="Adornment.Start"
                                          AdornmentIcon="@Icons.Material.Filled.Email" />

                            <!-- Birthday -->
                            <MudDatePicker @bind-Date="settingsModel.Second.Birthday"
                                           For="@(() => settingsModel.Second.Birthday)"
                                           Label="Birthday"
                                           Variant="Variant.Outlined"
                                           Clearable="true"
                                           ShowToolbar="false"
                                           DateFormat="dd/MM/yyyy"
                                           MaxDate="@DateTime.Today"
                                           Adornment="Adornment.Start"
                                           AdornmentIcon="@Icons.Material.Filled.Cake" />

                            <!-- Country -->
                            <MudAutocomplete T="IsoCountry" @bind-Value="settingsModel.Second.Country"
                                            ToStringFunc="@(c => c == null ? null : $"{c.Name} ({c.Alpha_3})")"
                                            SearchFunc="SearchCountry"
                                            Variant="Variant.Outlined"
                                            Label="Country"
                                            Clearable="true"
                                            Strict="false"
                                            Adornment="Adornment.Start"
                                            AdornmentIcon="@Icons.Material.Filled.Flag">
                                <NoItemsTemplate>
                                    <MudText Align="Align.Center"> No country matching your search... </MudText>
                                </NoItemsTemplate>
                            </MudAutocomplete>

                        </MudStack>
                    </MudForm>
                </MudPaper>
            </MudItem>
            <MudItem xs="12" md="6">
                <MudStack Spacing="3">
                    <MudPaper Class="pa-4" Elevation="6" Style="background: linear-gradient(145deg, #2a2a2a, #1a1a1a);">
                        <MudStack Row="true" AlignItems="AlignItems.Center" Spacing="1" Class="mb-3">
                            <MudIcon Icon="@Icons.Material.Filled.Password" Size="Size.Medium" />
                            <MudText Typo="Typo.h5" Style="color: #764ba2;">
                                Password Settings
                            </MudText>
                        </MudStack>
                            <MudForm @ref="settingsForm" Model="@settingsModel" Validation="@ValidateSettings">
                                <!-- Password Section -->
                                <MudText Typo="Typo.h6" Style="color: #667eea;">
                                    Change Password 
                                </MudText>
                                
                                <MudTextField @bind-Value="settingsModel.First.Password"
                                            For="@(() => settingsModel.First.Password)"
                                            Label="New Password"
                                            InputType="InputType.Password"
                                            Variant="Variant.Outlined"
                                            HelperText="Leave empty to keep current password"
                                            Adornment="Adornment.Start"
                                            AdornmentIcon="@Icons.Material.Filled.Lock" />
                                <MudCollapse Expanded="@(!string.IsNullOrWhiteSpace(settingsModel.First.Password))">
                                    <MudTextField @bind-Value="settingsModel.First.RepeatPassword"
                                                For="@(() => settingsModel.First.RepeatPassword)"
                                                Label="Confirm New Password"
                                                InputType="InputType.Password"
                                                Variant="Variant.Outlined"
                                                Adornment="Adornment.Start"
                                                AdornmentIcon="@Icons.Material.Filled.Lock" />
                                </MudCollapse>
                            </MudForm>
                    </MudPaper>

                    <!-- Action Buttons -->
                    <MudPaper Class="pa-4" Elevation="6" Style="background: linear-gradient(145deg, #2a2a2a, #1a1a1a);">
                        <MudStack Row="true" AlignItems="AlignItems.Center" Spacing="1" Class="mb-3">
                            <MudStack Row="true" Spacing="2" Class="mt-4">
                                <MudButton Variant="Variant.Filled"
                                            Color="Color.Primary"
                                            StartIcon="@Icons.Material.Filled.Save"
                                            OnClick="SaveSettings"
                                            Disabled="@(isSaving || !settingsHasChanged || !settingsValidation)">
                                    @(isSaving ? "Saving..." : "Save Changes")
                                </MudButton>
                                <MudButton Variant="Variant.Outlined"
                                            Color="Color.Default"
                                            StartIcon="@Icons.Material.Filled.Cancel"
                                            OnClick="CancelSettingsWrapper">
                                    Cancel
                                </MudButton>
                            </MudStack>
                        </MudStack>
                    </MudPaper>
                </MudStack>
            
                <MudCollapse Expanded="@(!string.IsNullOrEmpty(settingsMessage))">
                    <MudAlert Severity="@settingsMessageSeverity" Class="mt-2">
                        @settingsMessage
                    </MudAlert>
                </MudCollapse>

            </MudItem>
            }
        </MudGrid>
    </MudContainer>

    <CustomDialog @ref="confirmCancel"
                Title="Cancel"
                Icon="@Icons.Material.Filled.Announcement"
                OnConfirm="CancelSettings">
        <MudText> Unsaved changes will be lost. Continue? </MudText>
    </CustomDialog>
}

@code{
    [Parameter] public IUserDto? user { get; set; }
    [Parameter] public List<DetailReviewDto>? userReviews { get; set; }
    [Parameter] public CardContainer[]? favoriteGameCards { get; set; }
    [Parameter] public int totalPagesFavorite { get; set; }
    [Parameter] public int totalPagesReviews { get; set; }
    [Parameter] public EventCallback OnUserUpdated { get; set; }

    [Parameter] public UserForm settingsModel { get; set; } = new();
    private UserForm oldSettings = null!;

    private bool IsPrivateProfile => user is PrivateUserDto;
    private bool showSettings = false;
    private PrivateUserDto? AsPrivate => user as PrivateUserDto;

    // Settings form
    private MudForm? settingsForm;
    private bool isSaving = false;
    private string settingsMessage = "";
    private Severity settingsMessageSeverity = Severity.Info;

    private string countryString = "";

    private CustomDialog? confirmCancel;
    private bool settingsHasChanged = false;
    private bool usernameAvailable = true;
    private bool emailAvailable = true;
    private bool settingsValidation = true;
    private UserFormUpdateValidator settingsValidator = null!;

    private Func<object, string, Task<IEnumerable<string>>> ValidateSettings => async (model, propertyName) =>
    {
        if (settingsValidator is null) return Array.Empty<string>();

        
        var validation = await settingsValidator.ValidateAsync((UserForm)model);
        settingsValidation = validation.IsValid;
        settingsHasChanged = true;

        StateHasChanged();
        Console.WriteLine("-------------------Validation-------------------------");
        if (!validation.IsValid)
        {
            Console.WriteLine($"Form validation failed.");
            var dict = validation.ToDictionary();
            foreach (var kv in dict)
            {
                Console.WriteLine($"- {kv.Key}: {string.Join("\n    ", kv.Value)}");
            }
        }
        else Console.WriteLine($"Form validation passed!");
        Console.WriteLine("------------------------------------------------------");

        if (validation.IsValid) return Array.Empty<string>();

        var propertyErrors = validation.Errors
            .Where(e => e.PropertyName == propertyName)
            .Select(e => e.ErrorMessage);

        return propertyErrors;
    };

    private async Task<IEnumerable<IsoCountry>> SearchCountry(string value, CancellationToken token)
    {
        Dictionary<int, IsoCountry> countriesDict = null!;
        try { countriesDict = await countriesMap.GetAsync(); }
        catch { return []; }

        var countries = countriesDict.Values;
        
        if (string.IsNullOrEmpty(value)) return countries;

        return countries
            .Where(c => c.Name.Contains(value, StringComparison.InvariantCultureIgnoreCase));
    }

    private async Task<string> GetCountryName(int? countryCode)
    {
        IsoCountry? country = null;
        if (countryCode is not null) country = await countriesMap.GetAsync((int)countryCode);
        
        if (country is null) return "No country selected";


        return $"{country.Name} ({country.Alpha_3})";
    }


    private async Task SaveSettings()
    {
        if (settingsForm == null || AsPrivate == null) return;


        // Validar formulario
        var validation = await settingsValidator.ValidateAsync((UserForm)settingsModel);

        if (!validation.IsValid)
        {
            settingsMessage = "Please fix the errors in the form.";
            settingsMessageSeverity = Severity.Error;
            return;
        }

        isSaving = true;
        settingsMessage = "";

        try
        {
            var updateRequest = new UpdateUserRequest(
                Username: settingsModel.First.Username!,
                Email: settingsModel.First.Email!,
                Password: settingsModel.First.Password,
                FullName: settingsModel.Second.FullName,
                Birthday: settingsModel.Second.Birthday,
                Country: settingsModel.Second.Country?.Country_code
            );

            var response = await ApiService.PutAsync<UpdateUserRequest, BasicUserDto>(
                APIUTILS.URIS.UPDATEPROFILE, 
                updateRequest
            );

            if (response != null)
            {
                settingsMessage = "Settings saved successfully!";
                settingsMessageSeverity = Severity.Success;

                oldSettings = new UserForm(settingsModel);
                oldSettings.First.Password = null!;
                oldSettings.First.RepeatPassword = null;

                settingsValidator = new UserFormUpdateValidator(
                    new UserFirstStepUpdateValidator
                        (checkAvailables, settingsModel.Username, settingsModel.Email),
                    new UserSecondStepUpdateValidator(countriesMap));

                StateHasChanged();
                // Volver a la vista principal después de 2 segundos
                await Task.Delay(2000);
                
                // Notificar al componente padre que se actualizó el usuario
                showSettings = false;
                settingsMessage = "";

                await OnUserUpdated.InvokeAsync();
            }
            else
            {
                settingsMessage = "Failed to save settings. Please try again.";
                settingsMessageSeverity = Severity.Error;
            }
        }
        catch (Exception ex)
        {
            settingsMessage = $"Error: {ex.Message}";
            settingsMessageSeverity = Severity.Error;
        }
        finally
        {
            isSaving = false;
        }
    }

    private void CancelSettingsWrapper()
    {
        if (settingsHasChanged) confirmCancel?.Open();
        else CancelSettings();
    }


    private void CancelSettings()
    {
        showSettings = false;
        settingsHasChanged = false;
        settingsModel = new UserForm(oldSettings);
        settingsMessage = "";
    }

    private async Task OnPageReviewsChanged(int page)
    {
        userReviews = null; // Mostrar skeleton mientras se carga la nueva página

        try
        {
            var apiRequest = $"{APIUTILS.URIS.PROFILE}&page={page - 1}&field=0";
            var response = await ApiService.PrivateGetAsync<PagedResult<DetailReviewDto>>(apiRequest);
            userReviews = response?.Data.ToList() ?? new List<DetailReviewDto>();
        }
        catch (Exception ex)
        {
            Console.WriteLine($"Error loading user reviews: {ex.Message}");
        }

    }

    private async Task OnPageFavoriteChanged(int page)
    {
        favoriteGameCards = null; // Mostrar skeleton mientras se carga la nueva página

        try
        {
            var apiRequest = $"{APIUTILS.URIS.PROFILE}&page={page - 1}&field=1";
            var response = await ApiService.PrivateGetAsync<PagedResult<DetailReviewDto>>(apiRequest);
            favoriteGameCards = response?.Data.Select(r => new CardContainer(new BasicGameCardStrat(false), r.Game!)).ToArray();
        }
        catch (Exception ex)
        {
            Console.WriteLine($"Error loading favorite games: {ex.Message}");
        }
    }

    protected override async Task OnParametersSetAsync()
    {
        if (settingsModel is not null)
        {
            countryString = await GetCountryName(settingsModel.Country?.Country_code);

            oldSettings = new UserForm(settingsModel);

            settingsValidator = new UserFormUpdateValidator(
                new UserFirstStepUpdateValidator
                    (checkAvailables, settingsModel.Username, settingsModel.Email),
                new UserSecondStepUpdateValidator(countriesMap)
            );
        }
    }
}