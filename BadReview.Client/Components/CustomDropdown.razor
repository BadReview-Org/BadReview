@inject NavigationManager Navigation
@typeparam T

<MudAutocomplete T="T"
    Label="@Label"
    SearchFunc="@OnSearchElements"
    Variant="Variant.Outlined"
    Margin="Margin.Dense"
    AdornmentIcon="@Icons.Material.Filled.Search"
    Adornment="Adornment.Start"
    Clearable="true"
    ValueChanged="@OnDropdownChanged"
    ResetValueOnEmptyText="true"
    CoerceText="true"
    ToStringFunc="ToStringFunc"
    DebounceInterval="@DebounceTime"
    SelectOnActivation="true"
    MaxItems="@MaxItem"
    MinCharacters="@MinChars"
    @attributes="GetValueAttribute()"
    @ref = "_thisDropdown">
        <ItemTemplate Context="element">
            @(ItemTemplate?.Invoke(element))
        </ItemTemplate>
</MudAutocomplete>

@code{
    [Parameter] public string Label { get; set; } = "Search...";
    [Parameter] public EventCallback<T?> DropdownChanged { get; set; }
    [Parameter] public Func<string, Task<IEnumerable<T>>>? SearchElements { get; set; }
    [Parameter] public RenderFragment<T>? ItemTemplate { get; set; }
    [Parameter] public Func<T?, string>? ToStringFunc { get; set; }
    [Parameter] public bool ClearOnNavigation { get; set; } = false;
    [Parameter] public int DebounceTime { get; set; } = 500; 
    [Parameter] public int MinChars { get; set; } = 0;
    [Parameter] public int? MaxItem { get; set; } = null;
    [Parameter] public T? Value { get; set; } = default;
    [Parameter] public bool HasValue { get; set; } = false;

    private MudAutocomplete<T> _thisDropdown = null!;
    private string lastSearchString = "";
    private IEnumerable<T>? lastSearch;

    private Dictionary<string, object?> GetValueAttribute()
    {
        return HasValue
            ? new Dictionary<string, object?> { { "Value", Value } }
            : new Dictionary<string, object?>();
    }

    private async Task<IEnumerable<T>> OnSearchElements(string value, CancellationToken token)
    {
        if (value == lastSearchString) return lastSearch ?? Enumerable.Empty<T>();

        // Si hay un callback definido, se busca en la API
        if (SearchElements != null)
        {
            lastSearch = await SearchElements(value);
            lastSearchString = value;
            
            return lastSearch ?? Enumerable.Empty<T>();
        }
        
        return Enumerable.Empty<T>();
    }

    private void ClearDropdown()
    {
        _thisDropdown.ClearAsync();
        _thisDropdown.BlurAsync();
    }

    private void OnDropdownChanged(T element) {
        Value = element;
        DropdownChanged.InvokeAsync(element);
    }

    protected override void OnInitialized()
    {
        if (ClearOnNavigation)
            Navigation.LocationChanged += (_, __) => ClearDropdown();
    }
}
