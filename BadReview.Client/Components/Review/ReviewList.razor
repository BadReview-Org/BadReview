@using System.Globalization
@using MudBlazor.Utilities
@inject IJSRuntime JS
<style>
    .game-link, .user-link {
        text-decoration: none;
        color: inherit;
        transition: color 0.2s ease, text-shadow 0.2s ease;
        display: inline-block;
    }
    
    .game-link:hover, .user-link:hover {
        color: #667eea;
        text-shadow: 0 0 8px rgba(102, 126, 234, 0.3);
    }
</style>

<MudPaper Class="pa-4" Elevation="6" Style="background: linear-gradient(145deg, #2a2a2a, #1a1a1a);">
    <MudText Typo="Typo.h5" Class="mb-3" Style="color: #667eea;">
    <MudIcon Icon="@Icons.Material.Filled.RateReview" Size="Size.Medium" Class="mr-2" />
        Reviews (@totalCount)
    </MudText>
    <MudStack Spacing="2">

    @if (Reviews == null)
    {
        <MudStack Spacing="2">
            @for (int i = 0; i < 6; i++)
            {
                <MudPaper Class="pa-3" Elevation="2" Style="background: rgba(255,255,255,0.05);">
                    <MudStack Row="true" Spacing="2" Style="flex: 1;">
                        @if(!Style)
                        {
                            <MudSkeleton SkeletonType="SkeletonType.Rectangle" Width="50px" Height="70px" />
                        }
                        <MudStack Spacing="1" Style="flex: 1;">
                            <MudStack Row="true" Justify="Justify.SpaceBetween" AlignItems="AlignItems.Center" Style="width: 100%;">
                                <MudStack Row="true" Spacing="1" Style="flex: 1;">
                                    <MudSkeleton SkeletonType="SkeletonType.Text" Width="60%" Height="24px" />
                                    <MudSkeleton SkeletonType="SkeletonType.Rectangle" Width="80px" Height="24px" Style="border-radius: 12px;" />
                                </MudStack>
                                <MudSkeleton SkeletonType="SkeletonType.Rectangle" Width="120px" Height="20px" />
                            </MudStack>
                            <MudSkeleton SkeletonType="SkeletonType.Text" Width="100%" Height="18px" />
                            <MudSkeleton SkeletonType="SkeletonType.Text" Width="80%" Height="18px" />
                            <MudSkeleton SkeletonType="SkeletonType.Text" Width="100px" Height="16px" Class="mt-1" />
                        </MudStack>
                    </MudStack>
                </MudPaper>
            }
        </MudStack>
    }
    else if (Reviews.Count == 0)
    {
        <MudText Typo="Typo.body2" Align="Align.Center" Style="color: #808080; padding: 40px 0;">
            No reviews yet. Start reviewing games!
        </MudText>
    }
    else
    {
        @foreach (var review in Reviews)
        {
            <MudPaper Class="pa-3" Elevation="2" Style="background: rgba(255,255,255,0.05);">
                <MudStack Row="true" Spacing="2" Style="flex: 1;">
                    @if(!Style){ //cover image
                    <MudPaper Width="50px" Elevation="2" Style="height: 70px; background: rgba(255,255,255,0.05); padding: 0; overflow: hidden; display: flex; align-items: center; justify-content: center;">
                        <img src="@ImageHelper.GetCoverUrl(review.Game?.CoverId)" 
                            alt="@review.Game?.Name"
                            style="max-width: 100%; max-height: 100%; object-fit: contain; transition: transform 0.3s ease;"
                            class="game-cover" />
                    </MudPaper>
                    }
                    <MudStack Spacing="1" Style="flex: 1;">
                        <MudStack Row="true" Justify="Justify.SpaceBetween" AlignItems="AlignItems.Center" Style="width: 100%;">
                            <MudStack Row="true" Spacing="1" AlignItems="AlignItems.Center">
                                @if (Style)
                                {
                                <MudLink Href="@($"/user/{review.User?.Id}")" Class="user-link">
                                    @(review.User?.Username ?? "Unknown User")
                                </MudLink>
                                }
                                else
                                {
                                <MudLink Href="@($"/game/{review.Game?.Id}")" Class="game-link">
                                    @(review.Game?.Name ?? "Unknown Game")
                                </MudLink>
                                }
                                <MudChip T="string" Size="Size.Small" Color="Color.Info">
                                    @review.StateEnum.ToString()
                                </MudChip>
                                @if (review.StartDate.HasValue || review.EndDate.HasValue)
                                {
                                    <MudText Typo="Typo.subtitle2" Style="color: #808080;">
                                        @(review.StartDate?.ToString("MMM dd, yyyy") ?? "?") - @(review.EndDate?.ToString("MMM dd, yyyy") ?? "?")
                                    </MudText>
                                }
                            </MudStack>
                            @if (review.Rating > 0)
                            {
                                <MudRating Disabled=true SelectedValue="@review.Rating" ReadOnly="true" Size="Size.Small" />
                            }
                        </MudStack>
                        @if (!string.IsNullOrEmpty(review.ReviewText))
                        {
                            <CustomTruncatedText Summary="@review.ReviewText" />
                        }
                        <MudStack Row="true" Spacing="1">
                            <MudText Typo="Typo.caption" Style="color: #808080;">
                                @review.CreatedAt.ToString("MMM dd, yyyy", CultureInfo.InvariantCulture)
                            </MudText>
                        </MudStack>
                    </MudStack>
                </MudStack>
            </MudPaper> 
        }
    }
    </MudStack>
    @if (totalPages > 1)
    {
    <div class="d-flex flex-column align-center">
        <MudPagination Color="Color.Dark" Class="mt-4" SelectedChanged="@OnPageChanged" BoundaryCount="5" Count="totalPages" Selected="@_selected" />
    </div>
    }
</MudPaper>

@code{
    [Parameter] public List<DetailReviewDto> Reviews { get; set; } = new();
    [Parameter] public bool Style { get; set; } = true;
    [Parameter] public EventCallback<int> PageChanged { get; set; }

    [Parameter] public int totalPages { get; set; } = 1;

    [Parameter] public int totalCount { get; set; } = 0;

    private int _selected = 1;

    private void OnPageChanged(int page)
    {
        _selected = page;
        PageChanged.InvokeAsync(page);
    }
}