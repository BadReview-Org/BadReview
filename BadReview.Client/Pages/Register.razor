@using FluentValidation

@page "/register"

@inject ILogger<Login> Logger
@inject HttpClient Client
@inject NavigationManager Navigation

<PageTitle>Register</PageTitle>

<MudContainer MaxWidth="MaxWidth.Small">
    <MudCard Elevation=8 Class="pa-6">
        <MudCardHeader>
        <MudText Typo="Typo.h3"> Register </MudText>
        </MudCardHeader>

        <MudCardContent>
            <MudForm Model="@model" @ref="@form" Validation="@(ValidateState)" Spacing="4">

                <MudTextField @bind-Value="model.Username" Label="Username"
                    For="@(() => model.Username)" HelperText="*Required"/>

                <MudTextField @bind-Value="model.Password" InputType="InputType.Password"
                    For="@(() => model.Password)" Label="Password" HelperText="*Required"/>

                <MudTextField @bind-Value="model.RepeatPassword" InputType="InputType.Password"
                    For="@(() => model.RepeatPassword)" Label="Repeat Password" HelperText="*Required"/>

                <MudTextField @bind-Value="model.Email" Label="Email"
                    For="@(() => model.Email)" HelperText="*Required"/>

                <MudTextField @bind-Value="model.FullName" Label="Full Name"
                    For="@(() => model.FullName)" HelperText="Optional"/>

                <MudDatePicker @bind-Date="model.Birthday" Label="Birthday" For="@(() => model.Birthday)"
                    HelperText="Optional" ShowToolbar="false" DateFormat="dd/MM/yyyy" Clearable="true"/>

<!--
                <MudTextField @bind-Value="model.Country" Label="Country"
                    For="@(() => model.Country)" HelperText="Optional" />
-->
                <MudAutocomplete T="IsoCountry" @bind-Value="model.Country"
                                SearchFunc="SearchCountry"
                                Variant="Variant.Outlined"
                                Label="Country"
                                HelperText="Optional"
                                Clearable="true">
                    <ItemTemplate Context="c">
                        <MudText>@($"{c.Name} ({c.Alpha_3})")</MudText>
                    </ItemTemplate>
                </MudAutocomplete>

                <MudPaper MaxWidth="25%" Elevation=0>
                    <MudButton Disabled="!enableFormButton" Class="mt-8" Size="Size.Large" Variant="Variant.Filled"
                        Color="Color.Primary" OnClick="RegisterAsync"> Register </MudButton>
                </MudPaper>
                <MudLink Href="/login">Already have an account? Log in.</MudLink>
            </MudForm>
        </MudCardContent>
    </MudCard>
</MudContainer>

@code {

    private async Task<IEnumerable<IsoCountry>> SearchCountry(string value, CancellationToken token)
    {
        if (!countriesFetched)
        {
            var url = Navigation.BaseUri + "iso3166.json";
            countries = await Client.GetFromJsonAsync<IsoCountry[]>(url, token);
            countriesFetched = true;
        }

        if (countries is null) return [];

        if (string.IsNullOrEmpty(value)) return countries;

        return countries
            .Where(c => c.Name.Contains(value, StringComparison.InvariantCultureIgnoreCase));
    }

    private Func<object, string, Task<IEnumerable<string>>> ValidateState => async (model, propertyName) =>
    {
        var validation = await validator.ValidateAsync((RegisterForm)model);
        enableFormButton = validation.IsValid;
        StateHasChanged();
        Console.WriteLine("-------------------Validation-------------------------");
        if (!validation.IsValid)
        {
            Console.WriteLine($"Form validation failed. validation.IsValid: {validation.IsValid}");
            var dict = validation.ToDictionary();
            foreach (var kv in dict)
            {
                Console.WriteLine($"- {kv.Key}: {string.Join("\n    ", kv.Value)}");
            }
        }
        else Console.WriteLine($"Form validation passed! validation.IsValid: {validation.IsValid}");
        Console.WriteLine("------------------------------------------------------");

        if (validation.IsValid) return Array.Empty<string>();

        var propertyErrors = validation.Errors
            .Where(e => e.PropertyName == propertyName)
            .Select(e => e.ErrorMessage);

        return propertyErrors;
    };

    [CascadingParameter]
    public AuthenticationStateProvider _provider { get; set; } = null!;
    JWTAuthStateProvider provider = null!;

    [CascadingParameter]
    public AuthService authS { get; set;} = null!;

    MudForm form = null!;
    RegisterForm model = new ();
    bool enableFormButton = false;
    RegisterFormValidator validator = new();

    bool countriesFetched = false;
    IsoCountry[]? countries = null;

    async Task RegisterAsync() {

        Console.WriteLine("Registering a new account...");

        CreateUserRequest request = new
            (model.Username, model.Email, model.Password, model.FullName,
            model.Birthday, model.Country?.Country_code);

        bool registered = await authS.RegisterAsync(provider, request);

        var msg = registered ? "Registered successfully!" : "Couldn't register.";

        Console.WriteLine(msg);

        if (registered) Navigation.NavigateTo("/");
    }

    protected override void OnInitialized()
    {
        provider = (JWTAuthStateProvider)_provider;
    }
}