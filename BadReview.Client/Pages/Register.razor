@using FluentValidation

@page "/register"

@inject ILogger<Login> Logger
@inject HttpClient Client
@inject NavigationManager Navigation

@inject IsoCountryMap countriesMap
@inject RegisterFirstStepValidator firstValidator
@inject RegisterSecondStepValidator secondValidator

<PageTitle>Register</PageTitle>

<MudContainer MaxWidth="MaxWidth.Small">
    <MudCard Elevation=8 Class="pa-6">
        <MudCardHeader>
        <MudText Typo="Typo.h3"> Register </MudText>
        </MudCardHeader>

        <MudCardContent>
            <MudStepper>
                <MudStep Title="Credentials">
                    <MudForm Model="@firstModel" @ref="@firstForm" Validation="@ValidateFirst">
                        <MudTextField @bind-Value="firstModel.Username" Label="Username"
                            For="@(() => firstModel.Username)" HelperText="*Required"/>

                        <MudTextField @bind-Value="firstModel.Password" InputType="InputType.Password"
                            For="@(() => firstModel.Password)" Label="Password" HelperText="*Required"/>

                        <MudTextField @bind-Value="firstModel.RepeatPassword" InputType="InputType.Password"
                            For="@(() => firstModel.RepeatPassword)" Label="Repeat Password" HelperText="*Required"/>

                        <MudTextField @bind-Value="firstModel.Email" Label="Email"
                            For="@(() => firstModel.Email)" HelperText="*Required"/>
                    </MudForm>
                </MudStep>
                <MudStep Title="Personal information" SecondaryText="Optional">
                    <MudForm Model="@secondModel" @ref="@secondForm" Validation="@ValidateSecond">
                        <MudTextField @bind-Value="secondModel.FullName" Label="Full Name"
                            For="@(() => secondModel.FullName)" HelperText="Optional"/>

                        <MudDatePicker @bind-Date="secondModel.Birthday" Label="Birthday" For="@(() => secondModel.Birthday)"
                            HelperText="Optional" ShowToolbar="false" DateFormat="dd/MM/yyyy" Clearable="true"/>

                        <MudAutocomplete T="IsoCountry" @bind-Value="secondModel.Country"
                                        ToStringFunc="@(c => c == null ? null : $"{c.Name} ({c.Alpha_3})")"
                                        SearchFunc="SearchCountry"
                                        Variant="Variant.Outlined"
                                        Label="Country"
                                        HelperText="Optional"
                                        Clearable="true">
                            <NoItemsTemplate>
                                <MudText Align="Align.Center"> No country matching your search... </MudText>
                            </NoItemsTemplate>
                        </MudAutocomplete>
                    </MudForm>
                </MudStep>
            </MudStepper>
<!--
            <MudForm Model="@model" @ref="@form" Validation="@(ValidateState)" Spacing="4">
                <MudPaper MaxWidth="25%" Elevation=0>
                    <MudButton Disabled="!enableFormButton" Class="mt-8" Size="Size.Large" Variant="Variant.Filled"
                        Color="Color.Primary" OnClick="RegisterAsync"> Register </MudButton>
                </MudPaper>
                <MudLink Href="/login">Already have an account? Log in.</MudLink>
-->
        </MudCardContent>
    </MudCard>
</MudContainer>

@code {

    private async Task<IEnumerable<IsoCountry>> SearchCountry(string value, CancellationToken token)
    {
        Dictionary<int, IsoCountry> countriesDict = null!;
        try { countriesDict = await countriesMap.GetAsync(); }
        catch { return []; }

        var countries = countriesDict.Values;
        
        if (string.IsNullOrEmpty(value)) return countries;

        return countries
            .Where(c => c.Name.Contains(value, StringComparison.InvariantCultureIgnoreCase));
    }

    private Func<object, string, Task<IEnumerable<string>>> ValidateFirst => async (model, propertyName) =>
    {
        var validation = await firstValidator.ValidateAsync((RegisterFirstStep)model);
        firstValidation = validation.IsValid;

        StateHasChanged();
        Console.WriteLine("-------------------Validation-------------------------");
        if (!validation.IsValid)
        {
            Console.WriteLine($"Form validation failed.");
            var dict = validation.ToDictionary();
            foreach (var kv in dict)
            {
                Console.WriteLine($"- {kv.Key}: {string.Join("\n    ", kv.Value)}");
            }
        }
        else Console.WriteLine($"Form validation passed!");
        Console.WriteLine("------------------------------------------------------");

        if (validation.IsValid) return Array.Empty<string>();

        var propertyErrors = validation.Errors
            .Where(e => e.PropertyName == propertyName)
            .Select(e => e.ErrorMessage);

        return propertyErrors;
    };

    private Func<object, string, Task<IEnumerable<string>>> ValidateSecond => async (model, propertyName) =>
    {
        var validation = await secondValidator.ValidateAsync((RegisterSecondStep)model);
        secondValidation = validation.IsValid;

        StateHasChanged();
        Console.WriteLine("-------------------Validation-------------------------");
        if (!validation.IsValid)
        {
            Console.WriteLine($"Form validation failed.");
            var dict = validation.ToDictionary();
            foreach (var kv in dict)
            {
                Console.WriteLine($"- {kv.Key}: {string.Join("\n    ", kv.Value)}");
            }
        }
        else Console.WriteLine($"Form validation passed!");
        Console.WriteLine("------------------------------------------------------");

        if (validation.IsValid) return Array.Empty<string>();

        var propertyErrors = validation.Errors
            .Where(e => e.PropertyName == propertyName)
            .Select(e => e.ErrorMessage);

        return propertyErrors;
    };

/*    private Func<object, string, IValidator, Task<IEnumerable<string>>> ValidateState =>
    async (model, propertyName, validator) =>
    {
        var validation = await validator.ValidateAsync((RegisterForm)model);
        enableFormButton = validation.IsValid;
        StateHasChanged();
        Console.WriteLine("-------------------Validation-------------------------");
        if (!validation.IsValid)
        {
            Console.WriteLine($"Form validation failed. validation.IsValid: {validation.IsValid}");
            var dict = validation.ToDictionary();
            foreach (var kv in dict)
            {
                Console.WriteLine($"- {kv.Key}: {string.Join("\n    ", kv.Value)}");
            }
        }
        else Console.WriteLine($"Form validation passed! validation.IsValid: {validation.IsValid}");
        Console.WriteLine("------------------------------------------------------");

        if (validation.IsValid) return Array.Empty<string>();

        var propertyErrors = validation.Errors
            .Where(e => e.PropertyName == propertyName)
            .Select(e => e.ErrorMessage);

        return propertyErrors;
    };
*/
    [CascadingParameter]
    public AuthenticationStateProvider _provider { get; set; } = null!;
    JWTAuthStateProvider provider = null!;

    [CascadingParameter]
    public AuthService authS { get; set;} = null!;

    MudForm firstForm = null!;
    MudForm secondForm = null!;
    RegisterFirstStep firstModel = new ();
    RegisterSecondStep secondModel = new();
    bool firstValidation, secondValidation;

    async Task RegisterAsync() {

        Console.WriteLine("Registering a new account...");

        CreateUserRequest request = new
            (firstModel.Username, firstModel.Email, firstModel.Password,
            secondModel.FullName, secondModel.Birthday, secondModel.Country?.Country_code);

        bool registered = await authS.RegisterAsync(provider, request);

        var msg = registered ? "Registered successfully!" : "Couldn't register.";

        Console.WriteLine(msg);

        if (registered) Navigation.NavigateTo("/");
    }

    protected override void OnInitialized()
    {
        provider = (JWTAuthStateProvider)_provider;
    }
}