@page "/register"

@inject ILogger<Login> Logger
@inject HttpClient Client
@inject NavigationManager Navigation

<PageTitle>Register</PageTitle>

<MudContainer MaxWidth="MaxWidth.Small">
    <MudCard Elevation=8 Class="pa-6">
        <MudCardHeader>
        <MudText Typo="Typo.h3"> Register </MudText>
        </MudCardHeader>

        <MudCardContent>
            <MudForm Spacing="4">
                <MudTextField @bind-Value="form.Username" Label="Username" HelperText="*Required" />
                <MudTextField @bind-Value="form.Password" InputType="InputType.Password" Label="Password" HelperText="*Required" />
                <MudTextField @bind-Value="form.RepeatPassword" InputType="InputType.Password" Label="Repeat Password" HelperText="*Required" />
                <MudTextField @bind-Value="form.Email" Label="Email" HelperText="*Required" />

                <MudTextField @bind-Value="form.FullName" Label="Full Name" HelperText="Optional" />
                <MudDatePicker @bind-Date="form.Birthday" Label="Birthday" HelperText="Optional" ShowToolbar="false" DateFormat="dd/MM/yyyy" />
                <MudTextField @bind-Value="form.Country" Label="Country" HelperText="Optional" />

                <MudPaper MaxWidth="25%" Elevation=0>
                    <MudButton Class="mt-8" Size="Size.Large" Variant="Variant.Filled" Color="Color.Primary" OnClick="@(async () => await RegisterAsync())"> Register </MudButton>
                </MudPaper>
                <MudLink Href="/login">Already have an account? Log in.</MudLink>
            </MudForm>
        </MudCardContent>
    </MudCard>
</MudContainer>

@code {

    [CascadingParameter]
    public AuthenticationStateProvider _provider { get; set; } = null!;
    JWTAuthStateProvider provider = null!;

    [CascadingParameter]
    public AuthService authS { get; set;} = null!;

    RegisterForm form = new ();

    async Task RegisterAsync() {
        if (string.IsNullOrWhiteSpace(form.Username) || string.IsNullOrWhiteSpace(form.Password) || string.IsNullOrWhiteSpace(form.Email))
        {
            Console.WriteLine("Can't register. Fill in the obligatory fields.");
            return;
        }

        Console.WriteLine("Registering a new account...");

        CreateUserRequest request = new (form.Username, form.Email, form.Password, form.FullName, form.Birthday, form.Country);

        bool registered = await authS.RegisterAsync(provider, request);

        var msg = registered ? "Registered successfully!" : "Couldn't register.";

        Console.WriteLine(msg);

        if (registered) Navigation.NavigateTo("/");
    }

    protected override void OnInitialized()
    {
        provider = (JWTAuthStateProvider)_provider;
    }
}