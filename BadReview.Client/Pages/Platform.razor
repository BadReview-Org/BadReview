@page "/platform/{id:int}"
@using BadReview.Shared.DTOs.Response
@using BadReview.Client.Utils
@using BadReview.Shared.Utils
@using Microsoft.JSInterop
@inject HttpClient Client
@inject NavigationManager Navigation
@inject IJSRuntime JS
@inject ApiService ApiService
@inject AuthenticationStateProvider _AuthStateProvider

<PageTitle>@platform?.Name</PageTitle>

@if (platform == null)
{
    <MudContainer MaxWidth="MaxWidth.Large" Class="mt-6">
        <MudGrid>
            <MudItem xs="12" md="4">
                <MudSkeleton SkeletonType="SkeletonType.Rectangle" Height="600px" />
            </MudItem>
            <MudItem xs="12" md="8">
                <MudSkeleton SkeletonType="SkeletonType.Rectangle" Height="100px" Class="mb-4" />
                <MudSkeleton SkeletonType="SkeletonType.Rectangle" Height="200px" Class="mb-4" />
                <MudSkeleton SkeletonType="SkeletonType.Rectangle" Height="400px" />
            </MudItem>
        </MudGrid>
    </MudContainer>
}
else
{
    <MudContainer MaxWidth="MaxWidth.ExtraExtraLarge" Class="mt-6">
        <MudGrid Spacing="4">
            <MudItem xs="12" md="12" lg="12">
            <!-- Título con Gradient dinámico basado en la cover -->
                <MudPaper Class="pa-4" Elevation="8" Style="@($"background: linear-gradient(135deg, {primaryColor} 0%, {secondaryColor} 100%); border-radius: 12px; transition: background 0.5s ease;")">
                    <MudText Align="Align.Center" Typo="Typo.h2" Style="font-weight: 700; color: white; text-shadow: 2px 2px 4px rgba(0,0,0,0.3);">
                        @platform.Name <br />
                        <MudText Typo="Typo.body2" Style="color: rgba(255,255,255,0.9);">
                            @(platform.Generation.HasValue ? "Generation " + platform.Generation.Value : "") 
                        </MudText>
                    </MudText>
                </MudPaper>
            </MudItem>
            <!-- Cover y Info Lateral - Primera Columna -->
            @if(platform.LogoId != null)
            {   
                <MudItem xs="12" md="6" lg="3">
                    <MudStack Spacing="3">
                        <!-- Cover Image -->
                        <MudPaper Elevation="10" Class="pa-3 mud-elevation-hover" Style="background: linear-gradient(145deg, #2a2a2a, #1a1a1a); transition: all 0.3s ease;">
                            <MudImage Src="@ImageHelper.GetCoverUrl(platform.LogoId)" 
                                    Alt="@platform.Name" 
                                    Class="rounded-lg" 
                                    Style="width: 100%; height: auto; box-shadow: 0 8px 32px rgba(0,0,0,0.4);" />
                        </MudPaper>
                        

                        
                    </MudStack>
                </MudItem>
            }
            
            <!-- Contenido Principal - Segunda Columna -->
            <MudItem xs="12" md="@descriptionWidth" lg="@descriptionWidth">
                <MudStack Spacing="4">

                    <!-- Description -->
                    <GameDescription Title="About This Platform" Summary="@platform.Summary" />
                </MudStack>
            </MudItem>
            
            <!-- Tercera Columna - Country -->
            @if (platform.PlatformType != null && platform.PlatformType != 0)
            {
            <MudItem xs="12" md="12" lg="3">
                <MudStack Spacing="3">
                    <!-- Country -->
                    @if (platform.PlatformType != null)
                    {
                    <GameInfoSection TItem="PlatformDto"
                                     Title="Platform Type"
                                     Icon="@Icons.Material.Filled.Flag"
                                     Items="@PlatformType"
                                     ChipColor="Color.Primary"
                                     RenderAsChips="false"
                                    >
                    <ItemTemplate Context="plat">
                        <MudStack Row="true" AlignItems="AlignItems.Center" Spacing="1">
                            <MudIcon Icon="@IconsMap.PlatformTypeIcon[(IconsMap.PlatformTypes)(platform.PlatformType ?? 0)]" Size="Size.Small" />
                             @plat.PlatformTypeName
                        </MudStack>
                    </ItemTemplate>
                    </GameInfoSection>
                    }

                </MudStack>
            </MudItem>
            }
            <!-- platform's Games -->
            <MudItem xs="12" md="12" lg="12">
                <MudPaper Class="pa-4" Elevation="6" Style="background: linear-gradient(145deg, #2a2a2a, #1a1a1a);">
                    <MudStack Row="true" AlignItems="AlignItems.Center" Spacing="1" Class="mb-3">
                        <MudText Typo="Typo.h5" Style="color: #764ba2;">
                            <MudIcon Icon="@Icons.Material.Filled.Games" Size="Size.Medium" />
                            @platform.Name Games
                        </MudText>
                    </MudStack>

                    <MudStack Spacing="1">
                        <CustomGridCard  pageSize="6" CardHeight="350" PageChanged="@OnplatformsGameChanged" totalPages="totalPagesGames" arrayElement="platformGames" placeholderTitle="No games found." placeholderBody="This company has no games." />
                    </MudStack>     
                </MudPaper>
            </MudItem>
        </MudGrid>
    </MudContainer>
}

@code{
    [Parameter] public int id { get; set; }
    private PlatformDto? platform { get; set; }
    private int totalPagesGames = 1;
    private CardContainer[]? platformGames { get; set; }
    private List<PlatformDto> PlatformType = new List<PlatformDto>();

    private int descriptionWidth = 6;
    protected override async Task OnInitializedAsync(){
        platform = await ApiService.PublicGetByIdAsync<PlatformDto>(APIUTILS.URIS.PLATFORMS, id);
        if(platform is not null)
            PlatformType.Add(platform);
        var GameRequest = new ApiRequest{
            URI = APIUTILS.URIS.GAMES,
            Filters = $"platforms = [{id}]",
            PageSize = 6,
            OrderBy = "total_rating_count",
            Order = SortOrder.DSC,
            Page = 0
        };
        PagedResult<BasicGameDto>? games = await ApiService.GetManyAsync<BasicGameDto>(GameRequest);
        platformGames = games?.Data.Select(g => new CardContainer(new BasicGameCardStrat(true), g)).ToArray();
        totalPagesGames = (int)Math.Ceiling((double)(games?.TotalCount ?? 0) / (games?.PageSize ?? 1));
        if(platform?.PlatformType is null){
            descriptionWidth += 3;
        }
        if(platform?.LogoId is null){
            descriptionWidth += 3;
        }
        await ExtractColorsFromCover();
    }

    private async Task ExtractColorsFromCover()
    {
        try
        {
            var coverUrl = ImageHelper.GetCoverUrl(platform?.LogoId);
            if (!string.IsNullOrEmpty(coverUrl))
            {
                var colors = await JS.InvokeAsync<ColorPalette>("colorExtractor.extractColors", coverUrl);
                if (colors != null)
                {
                    primaryColor = colors.Primary ?? "#667eea";
                    secondaryColor = colors.Secondary ?? "#764ba2";
                    StateHasChanged();
                }
            }
        }
        catch (Exception ex)
        {
            Console.WriteLine($"Error extracting colors: {ex.Message}");
            // Keep default colors
        }
    }
    private string primaryColor = "#667eea";
    private string secondaryColor = "#764ba2";

        private class ColorPalette
    {
        public string? Primary { get; set; }
        public string? Secondary { get; set; }
    }
    private async Task OnplatformsGameChanged(int page)
    {
        platformGames = null; // Mostrar skeleton mientras se carga la nueva página

        try
        {
                var GameRequest = new ApiRequest{
                    URI = APIUTILS.URIS.GAMES,
                    Filters = $"platforms = [{id}]",
                    PageSize = 6,
                    OrderBy = "total_rating_count",
                    Order = SortOrder.DSC,
                    Page = page - 1
                };
                PagedResult<BasicGameDto>? games = await ApiService.GetManyAsync<BasicGameDto>(GameRequest);
                platformGames = games?.Data.Select(g => new CardContainer(new BasicGameCardStrat(true), g)).ToArray();
        }
        catch (Exception ex)
        {
            Console.WriteLine($"Error loading games: {ex.Message}");
        }
    }


}