@using FluentValidation

@page "/login"

@inject ILogger<Login> Logger
@inject HttpClient Client
@inject NavigationManager Navigation

<PageTitle>Log in</PageTitle>

<MudContainer MaxWidth="MaxWidth.Small">
    <MudCard Elevation=8 Class="pa-6">
        <MudCardHeader>
        <MudText Typo="Typo.h3"> Log in </MudText>
        </MudCardHeader>

        <MudCardContent>
            <MudForm Model="@model" @ref="@form" Validation="@(ValidateState)" Spacing="4">

                <MudTextField @bind-Value="model.Username"
                    For="@(() => model.Username)" Label="Username" />

                <MudTextField @bind-Value="model.Password" For="@(() => model.Password)"
                    InputType="InputType.Password" Label="Password" />

                <MudPaper MaxWidth="25%" Elevation=0>
                    <MudButton Disabled="!enableFormButton" Class="mt-8" Size="Size.Large"
                        Variant="Variant.Filled" Color="Color.Primary" OnClick="LoginAsync"> Log in </MudButton>
                </MudPaper>
                <MudLink Href="/register">Don't have an account yet? Register.</MudLink>
            </MudForm>
        </MudCardContent>
    </MudCard>
</MudContainer>

@code {

    private Func<object, string, Task<IEnumerable<string>>> ValidateState => async (model, propertyName) =>
    {
        var validation = await validator.ValidateAsync((LoginForm)model);
        enableFormButton = validation.IsValid;

        if (!validation.IsValid)
        {
            var dict = validation.ToDictionary();
            foreach (var kv in dict)
            {
                Console.WriteLine($"- {kv.Key}: {string.Join("\n    ", kv.Value)}");
            }
        }

        if (validation.IsValid) return Array.Empty<string>();

        var propertyErrors = validation.Errors
            .Where(e => e.PropertyName == propertyName)
            .Select(e => e.ErrorMessage);

        return propertyErrors;
    };
    
    [CascadingParameter]
    public AuthenticationStateProvider _provider { get; set; } = null!;
    JWTAuthStateProvider provider = null!;

    [CascadingParameter]
    public AuthService authS { get; set;} = null!;

    MudForm form = null!;
    LoginForm model = new ();
    bool enableFormButton = false;
    LoginFormValidator validator = new();

    async Task LoginAsync() {
        Console.WriteLine("Now logging in...");

        LoginUserRequest request = new (model.Username, model.Password);

        bool login = await authS.LoginAsync(provider, request);

        var msg = login ? "Logged in successfully" : "Couldn't log in";

        Console.WriteLine(msg);

        if (login) Navigation.NavigateTo("/");
    }

    protected override void OnInitialized()
    {
        provider = (JWTAuthStateProvider)_provider;
    }
}