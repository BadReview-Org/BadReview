@page "/explore"
@using BadReview.Shared.DTOs.Response
@using BadReview.Client.Utils
@inject HttpClient Client
@inject NavigationManager Navigation

<PageTitle>Explore Games</PageTitle>

<AuthorizeView>
    <Authorized>
        <p>See any interesting games? You should add it to your pending list!</p>
    </Authorized>
    <NotAuthorized>
        <p>Create an account or log in to register your activity!</p>
    </NotAuthorized>
</AuthorizeView>

<MudContainer  MaxWidth="MaxWidth.ExtraLarge" Class="mt-4">
    <!-- Header con Gradient -->
    <MudPaper Class="pa-4 mb-6" Elevation="8" Style="background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); border-radius: 12px;">
        <MudStack Row="true" AlignItems="AlignItems.Center" Spacing="2">
            <MudIcon Icon="@Icons.Material.Filled.Whatshot" Size="Size.Large" Style="color: white;" />
            <MudText Typo="Typo.h3" Style="font-weight: 700; color: white; text-shadow: 2px 2px 4px rgba(0,0,0,0.3);">
                Explore Games
            </MudText>
        </MudStack>
        <MudText Typo="Typo.body1" Class="mt-2" Style="color: rgba(255,255,255,0.9);">
            Search for your favorite games and discover new ones! @SelectedFilter
        </MudText>
    </MudPaper>
    <MudPaper Class="pa-4 mb-4" Elevation="6">
        <CustomFilter SearchGenres="OnSearchGenresAsync" Platforms="@Platforms" Genres="@Genres" @bind-Value="_searchText" @bind-SelectedFilter="SelectedFilter" SetChips ="true"  OnSearchAsync="OnSearchAsync" Placeholder="Search for games..." />
    </MudPaper>
    <CustomGridCard arrayElement="gameCards"  placeholderTitle="No games found." placeholderBody="There are no games that match your filters."/>
</MudContainer>


@code {
    private CardContainer[]? gameCards;
    private List<PlatformDto> Platforms { get; set; } = new();
    private List<GenreDto> Genres { get; set; } = new List<GenreDto>();


    private string? SelectedFilter = "name";
    private string _searchText = string.Empty;
    private async Task<IEnumerable<GenreDto>> OnSearchGenresAsync(string searchText)
    {
        if (string.IsNullOrWhiteSpace(searchText))
        {
            // Retornar todos los g√©neros
            var allGenres = await Client.GetFromJsonAsync<GenreDto[]>("api/genres");
            return allGenres ?? Enumerable.Empty<GenreDto>();
        }
        string filters = (string.IsNullOrWhiteSpace(searchText)) ?
            "" : Uri.EscapeDataString($"name ~ *\"{searchText}\"*");

        string queryString = $"?filters={filters}";
        Console.WriteLine($"Query: {queryString}");
        var genres = await Client.GetFromJsonAsync<List<GenreDto>>($"api/genres{queryString}");
        if (genres is not null)
        {
            Genres = genres;
        }
        // Buscar en la API con el texto
        return genres ?? Enumerable.Empty<GenreDto>();
    }





    protected override async Task OnInitializedAsync()
    {
        await LoadGamesAsync();
    }

    private async Task LoadGamesAsync()
    {
        string uri = "api/games";
        string orderby = Uri.EscapeDataString("total_rating_count");
        string filters = (string.IsNullOrWhiteSpace(_searchText)) ?
            "" : Uri.EscapeDataString($"@{SelectedFilter} ~ *\"{_searchText}\"*");

        string queryString = $"?filters={filters}&orderby={orderby}";
        Console.WriteLine($"Query: {queryString}");
        BasicGameDto[]? gamesDto = await Client.GetFromJsonAsync<BasicGameDto[]>($"{uri}{queryString}");

        gameCards = gamesDto is null ? null :
            gameCards = gamesDto.Select(g => new CardContainer(new BasicGameCardStrat(), g)).ToArray();
    }

    private async Task OnSearchAsync(string searchText)
    {
        gameCards = null; // Mostrar skeletons mientras carga
        //StateHasChanged();
        await LoadGamesAsync();
    }
}