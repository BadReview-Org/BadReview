@page "/explore"
@using BadReview.Shared.DTOs.Response
@using BadReview.Client.Utils
@inject HttpClient Client
@inject NavigationManager Navigation

<PageTitle>Explore Games</PageTitle>

<AuthorizeView>
    <Authorized>
        <p>See any interesting games? You should add it to your pending list!</p>
    </Authorized>
    <NotAuthorized>
        <p>Create an account or log in to register your activity!</p>
    </NotAuthorized>
</AuthorizeView>

<MudContainer MaxWidth="MaxWidth.ExtraLarge" Class="mt-4">
    <!-- Header con Gradient -->
    <MudPaper Class="pa-4 mb-6" Elevation="8" Style="background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); border-radius: 12px;">
        <MudStack Row="true" AlignItems="AlignItems.Center" Spacing="2">
            <MudIcon Icon="@Icons.Material.Filled.Whatshot" Size="Size.Large" Style="color: white;" />
            <MudText Typo="Typo.h3" Style="font-weight: 700; color: white; text-shadow: 2px 2px 4px rgba(0,0,0,0.3);">
                Explore Games
            </MudText>
        </MudStack>
        <MudText Typo="Typo.body1" Class="mt-2" Style="color: rgba(255,255,255,0.9);">
            Search for your favorite games and discover new ones!
        </MudText>
    </MudPaper>
    <MudPaper Class="pa-4 mb-4" Elevation="6" Style="background: linear-gradient(145deg, #2a2a2a, #1a1a1a);">
        <MudTextField @bind-Value="_searchText" 
                      Placeholder="Search for games..." 
                      Adornment="Adornment.Start" 
                      AdornmentIcon="@Icons.Material.Filled.Search"
                      Variant="Variant.Outlined"
                      Immediate="true"
                      DebounceInterval="500"
                      OnDebounceIntervalElapsed="OnSearchAsync"
                      FullWidth="true"
                      Style="background: rgba(255,255,255,0.05); border-radius: 8px;" />
    </MudPaper>
    <CustomGridCard arrayElement="gameCards" placeholderTitle="No games found." placeholderBody="There are no games that match your filters."/>
</MudContainer>


@code {
    private CardContainer[]? gameCards;
    private string _searchText = string.Empty;

    protected override async Task OnInitializedAsync()
    {
        await LoadGamesAsync();
    }

    private async Task LoadGamesAsync()
    {
        string uri = "api/games";
        string orderby = Uri.EscapeDataString("total_rating_count");
        string filters = (string.IsNullOrWhiteSpace(_searchText)) ?
            "" : Uri.EscapeDataString($"name ~ *\"{_searchText}\"*");

        string queryString = $"?filters={filters}&orderby={orderby}";
        Console.WriteLine($"Query: {queryString}");
        BasicGameDto[]? gamesDto = await Client.GetFromJsonAsync<BasicGameDto[]>($"{uri}{queryString}");

        gameCards = gamesDto is null ? null :
            gameCards = gamesDto.Select(g => new CardContainer(new BasicGameCardStrat(), g)).ToArray();
    }

    private async Task OnSearchAsync(string searchText)
    {
        gameCards = null; // Mostrar skeletons mientras carga
        //StateHasChanged();
        await LoadGamesAsync();
    }
}