@page "/explore"
@using BadReview.Shared.DTOs.Response
@using BadReview.Client.Utils
@inject HttpClient Client
@inject NavigationManager Navigation
<PageTitle>Explore Games</PageTitle>

<MudContainer MaxWidth="MaxWidth.ExtraLarge" Class="mt-4">
    <!-- Header con Gradient -->
    <MudPaper Class="pa-4 mb-6" Elevation="8" Style="background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); border-radius: 12px;">
        <MudStack Row="true" AlignItems="AlignItems.Center" Spacing="2">
            <MudIcon Icon="@Icons.Material.Filled.Whatshot" Size="Size.Large" Style="color: white;" />
            <MudText Typo="Typo.h3" Style="font-weight: 700; color: white; text-shadow: 2px 2px 4px rgba(0,0,0,0.3);">
                Explore Games
            </MudText>
        </MudStack>
        <MudText Typo="Typo.body1" Class="mt-2" Style="color: rgba(255,255,255,0.9);">
            Search for your favorite games and discover new ones!
        </MudText>
    </MudPaper>
    <MudPaper Class="pa-4 mb-4" Elevation="6" Style="background: linear-gradient(145deg, #2a2a2a, #1a1a1a);">
        <MudTextField @bind-Value="_searchText" 
                      Placeholder="Search for games..." 
                      Adornment="Adornment.Start" 
                      AdornmentIcon="@Icons.Material.Filled.Search"
                      Variant="Variant.Outlined"
                      Immediate="true"
                      DebounceInterval="500"
                      OnDebounceIntervalElapsed="OnSearchAsync"
                      FullWidth="true"
                      Style="background: rgba(255,255,255,0.05); border-radius: 8px;" />
    </MudPaper>

    @if (games == null)
    {
        <MudGrid Spacing="4">
            @for (int i = 0; i < 12; i++)
            {
                <MudItem xs="12" sm="6" md="4" lg="3" xl="2">
                    <MudPaper Elevation="6" Style="background: linear-gradient(145deg, #2a2a2a, #1a1a1a); border-radius: 12px; overflow: hidden;">
                        <MudSkeleton SkeletonType="SkeletonType.Rectangle" Height="240px" />
                        <div class="pa-3">
                            <MudSkeleton SkeletonType="SkeletonType.Text" Height="25px" />
                        </div>
                    </MudPaper>
                </MudItem>
            }
        </MudGrid>
    }
    else if (games.Length == 0)
    {
        <MudPaper Class="pa-8 text-center" Elevation="4" Style="background: linear-gradient(145deg, #2a2a2a, #1a1a1a);">
            <MudIcon Icon="@Icons.Material.Filled.SearchOff" Size="Size.Large" Color="Color.Default" />
            <MudText Typo="Typo.h5" Class="mt-3">No games found.</MudText>
            <MudText Typo="Typo.body1" Class="mt-2" Color="Color.Default">
                Check back later for games!
            </MudText>
        </MudPaper>
    }
    else
    {
        <MudGrid Spacing="4">
            @foreach (var game in games)
            {
                var currentGame = game;
                <MudItem xs="12" sm="6" md="4" lg="3" xl="2">
                    <MudLink Href="@($"/game/{currentGame.Id}")" Style="text-decoration: none; color: inherit;">
                        <MudCard Class="mud-elevation-hover" 
                                 Style="height: 100%; 
                                        background: linear-gradient(145deg, #2a2a2a, #1a1a1a); 
                                        border-radius: 12px; 
                                        overflow: hidden;
                                        transition: transform 0.3s ease, box-shadow 0.3s ease;
                                        border: 1px solid rgba(102, 126, 234, 0.1);">
                            <div style="position: relative; overflow: hidden; height: 240px; display: flex; align-items: center; justify-content: center; background: #1a1a1a;">
                                <img src="@ImageHelper.GetCoverUrl(currentGame.Cover)" 
                                     alt="@currentGame.Name"
                                     style="max-width: 100%; max-height: 100%; object-fit: contain; transition: transform 0.3s ease;"
                                     class="game-cover" />
                            </div>
                            <MudCardContent Style="padding: 12px;">
                                <MudText Typo="Typo.body1" 
                                         Align="Align.Center" 
                                         Style="font-weight: 600; 
                                                color: #e0e0e0; 
                                                line-height: 1.2;
                                                min-height: 40px;
                                                display: flex;
                                                align-items: center;
                                                justify-content: center;
                                                font-size: 0.95rem;">
                                    @currentGame.Name
                                </MudText>
                            </MudCardContent>
                        </MudCard>
                    </MudLink>
                </MudItem>
            }
        </MudGrid>
    }
</MudContainer>

<style>
    .mud-elevation-hover:hover .game-cover {
        transform: scale(1.05);
    }
    
    .mud-elevation-hover:hover {
        transform: translateY(-8px);
        box-shadow: 0 12px 40px rgba(102, 126, 234, 0.4) !important;
        border-color: rgba(102, 126, 234, 0.5) !important;
    }
</style>
@code {
    private BasicGameDto[]? games;
    private string _searchText = string.Empty;

    protected override async Task OnInitializedAsync()
    {
        await LoadGamesAsync();
    }

    private async Task LoadGamesAsync()
    {
        string uri = "api/games";
        string orderby = Uri.EscapeDataString("total_rating_count");
        string filters = (string.IsNullOrWhiteSpace(_searchText)) ?
            "" : Uri.EscapeDataString($"name ~ *\"{_searchText}\"*");


        string queryString = $"?filters={filters}&orderby={orderby}";
        Console.WriteLine($"Query: {queryString}");
        games = await Client.GetFromJsonAsync<BasicGameDto[]>($"{uri}{queryString}");
    }

    private async Task OnSearchAsync(string searchText)
    {
        games = null; // Mostrar skeletons mientras carga
        //StateHasChanged();
        await LoadGamesAsync();
    }
}