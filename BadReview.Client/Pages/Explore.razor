@page "/explore"
@using BadReview.Shared.DTOs.Response
@using BadReview.Client.Utils
@using BadReview.Shared.Utils
@inject HttpClient Client
@inject NavigationManager Navigation
@inject ApiService ApiService

<PageTitle>Explore Games</PageTitle>

<AuthorizeView>
    <Authorized>
        @if(showLoggedAlert)
        {
            <MudAlert Severity="Severity.Normal" 
                Elevation="6" 
                Variant="Variant.Filled"
                ShowCloseIcon="true"
                CloseIconClicked="(() => showLoggedAlert = false)"
                Style="position: fixed; bottom: 20px; right: 20px; z-index: 1000; max-width: 350px; box-shadow: 0 8px 32px rgba(0,0,0,0.3);">
                See any interesting games? You should add it to your pending list!
            </MudAlert>
        }
    </Authorized>
    <NotAuthorized>
        @if(showLoggedAlert)
        {
            <MudAlert Severity="Severity.Normal" 
                Elevation="6" 
                Variant="Variant.Filled"
                ShowCloseIcon="true"
                CloseIconClicked="(() => showLoggedAlert = false)"
                Style="position: fixed; bottom: 20px; right: 20px; z-index: 1000; max-width: 350px; box-shadow: 0 8px 32px rgba(0,0,0,0.3);">
                 Create an account or log in to register your activity!
            </MudAlert>
        }
    </NotAuthorized>
</AuthorizeView>

<MudContainer  MaxWidth="MaxWidth.ExtraLarge" Class="mt-4">
    <!-- Header con Gradient -->
    <MudPaper Class="pa-4 mb-6" Elevation="8" Style="background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); border-radius: 12px;">
        <MudStack Row="true" AlignItems="AlignItems.Center" Spacing="2">
            <MudIcon Icon="@Icons.Material.Filled.Whatshot" Size="Size.Large" Style="color: white;" />
            <MudText Typo="Typo.h3" Style="font-weight: 700; color: white; text-shadow: 2px 2px 4px rgba(0,0,0,0.3);">
                Explore Games
            </MudText>
        </MudStack>
        <MudText Typo="Typo.body1" Class="mt-2" Style="color: rgba(255,255,255,0.9);">
            Search for your favorite games and discover new ones!
        </MudText>
    </MudPaper>
    <MudPaper Class="pa-4 mb-4" Elevation="6">
        <CustomFilter Dropdown="false" @bind-extraFilters="@extraFilters" ClickApplyFilters="OnFilterChanged" SearchDevelopers="OnSearchDevelopersAsync" SearchGenres="OnSearchGenresAsync" SearchPlatforms="OnSearchPlatformAsync" Developers="@Developers" Platforms="@Platforms" Genres="@Genres" @bind-Value="_searchText" @bind-SelectedFilter="SelectedFilter" SetChips ="true"  OnSearchAsync="OnSearchAsync" Placeholder="Search for games..." />
    </MudPaper>
    <CustomGridCard selectedPage="@selectedPage" CardHeight="350" totalPages="@totalPages" arrayElement="gameCards" PageChanged="OnPageChanged" placeholderTitle="No games found." placeholderBody="There are no games that match your filters."/>
</MudContainer>


@code {
    private CardContainer[]? gameCards;
    private List<PlatformDto> Platforms { get; set; } = new();
    private List<GenreDto> Genres { get; set; } = new List<GenreDto>();

    private List<BasicDeveloperDto> Developers { get; set;} = new List<BasicDeveloperDto>();

    private string extraFilters = "";
    private int totalPages = 1;

    private bool showLoggedAlert = true;

    private int selectedPage = 1;
    private string? SelectedFilter = "released";
    private string _searchText = string.Empty;
    private async Task<IEnumerable<GenreDto>> OnSearchGenresAsync(string searchText)
    {
        ApiRequest apiRequest = new ApiRequest{
            URI = APIUTILS.URIS.GENRES, 
            PageSize = 10,
            Page = 0 };

        if (string.IsNullOrWhiteSpace(searchText))
        {
            // Retornar todos los géneros
            var allGenres = await ApiService.GetManyAsync<GenreDto>(apiRequest);
            return allGenres?.Data ?? Enumerable.Empty<GenreDto>();
        }
        apiRequest.Filters = $"@name ~ *\"{searchText}\"*";
        apiRequest.OrderBy = "name";
        apiRequest.Order = SortOrder.ASC;
        PagedResult<GenreDto>? responseDto = await ApiService.GetManyAsync<GenreDto>(apiRequest);
        if (responseDto != null)
        {
            totalPages = (responseDto?.TotalCount ?? 0 )/ (responseDto?.PageSize ?? 1);
            gameCards = responseDto?.Data.Select(g => new CardContainer(new BasicGameCardStrat(), g)).ToArray();
            return responseDto?.Data ?? Enumerable.Empty<GenreDto>();
        }
        return Enumerable.Empty<GenreDto>();
    }

    private async Task<IEnumerable<BasicDeveloperDto>> OnSearchDevelopersAsync(string searchText)
    {
        ApiRequest apiRequest = new ApiRequest{
            URI = APIUTILS.URIS.DEVELOPERS, 
            PageSize = 10,
            Page = 0 };

        if (string.IsNullOrWhiteSpace(searchText))
        {
            // Retornar todos los géneros
            var allDevelopers = await ApiService.GetManyAsync<BasicDeveloperDto>(apiRequest);
            return allDevelopers?.Data ?? Enumerable.Empty<BasicDeveloperDto>();
        }
        apiRequest.Filters = $"@name ~ *\"{searchText}\"*";
        apiRequest.OrderBy = "name";
        apiRequest.Order = SortOrder.ASC;
        PagedResult<BasicDeveloperDto>? responseDto = await ApiService.GetManyAsync<BasicDeveloperDto>(apiRequest);
        if (responseDto != null)
        {
            totalPages = (responseDto?.TotalCount ?? 0 )/ (responseDto?.PageSize ?? 1);
            gameCards = responseDto?.Data.Select(g => new CardContainer(new BasicGameCardStrat(), g)).ToArray();
            return responseDto?.Data ?? Enumerable.Empty<BasicDeveloperDto>();
        }
        return Enumerable.Empty<BasicDeveloperDto>();
    }


    private async Task<IEnumerable<PlatformDto>> OnSearchPlatformAsync(string searchText)
    {    
        ApiRequest apiRequest = new ApiRequest{
            URI = APIUTILS.URIS.PLATFORMS, 
            PageSize = 10,
            Page = 0 };

        if (string.IsNullOrWhiteSpace(searchText))
        {
            // Retornar todos los géneros
            var allPlatform = await ApiService.GetManyAsync<PlatformDto>(apiRequest);
            return allPlatform?.Data ?? Enumerable.Empty<PlatformDto>();
        }
        apiRequest.Filters = $"@name ~ *\"{searchText}\"*";
        apiRequest.OrderBy = "name";
        apiRequest.Order = SortOrder.ASC;
        PagedResult<PlatformDto>? responseDto = await ApiService.GetManyAsync<PlatformDto>(apiRequest);
        if (responseDto != null)
        {
            totalPages = (responseDto?.TotalCount ?? 0 )/ (responseDto?.PageSize ?? 1);
            gameCards = responseDto?.Data.Select(g => new CardContainer(new BasicGameCardStrat(), g)).ToArray();
            return responseDto?.Data ?? Enumerable.Empty<PlatformDto>();
        }
        return Enumerable.Empty<PlatformDto>();
    }


    protected override async Task OnInitializedAsync()
    {
        await LoadGamesAsync();
    }

    private async Task LoadGamesAsync(int page = 1,string extraFilters = "")
    {
    
        ApiRequest apiRequest = new ApiRequest{
                    URI = APIUTILS.URIS.GAMES, 
                    Filters = (extraFilters == string.Empty) ?  $"name ~ *\"{_searchText}\"*" : $"name ~ *\"{_searchText}\"*&{extraFilters}",
                    OrderBy = "total_rating_count",
                    Page = page-1 };

        PagedResult<BasicGameDto>? responseDto = await ApiService.GetManyAsync<BasicGameDto>(apiRequest);
        totalPages = (int)Math.Ceiling((double)(responseDto?.TotalCount ?? 0 )/ (responseDto?.PageSize ?? 1));
        gameCards = responseDto?.Data.Select(g => new CardContainer(new BasicGameCardStrat(), g)).ToArray();
    }

    private async Task OnSearchAsync(string searchText)
    {
        gameCards = null; // Mostrar skeletons mientras carga
        selectedPage = 1;
        await LoadGamesAsync(page: 1,extraFilters);
    }
    
    private async Task OnPageChanged(int page)
    {
        gameCards = null; // Mostrar skeletons mientras carga la nueva página
        selectedPage = page;    

        await LoadGamesAsync(page, extraFilters);
    }

    private async Task OnFilterChanged(string filter)
    {
        gameCards = null; // Mostrar skeletons mientras carga la nueva página
        selectedPage = 1;
        await LoadGamesAsync(page: 1,filter);
    }
}