@page "/profile"
@page "/user/{id:int}"
@using BadReview.Shared.DTOs.Response
@using BadReview.Shared.Utils
@using BadReview.Client.Utils
@using System.Globalization
@inject HttpClient Client
@inject NavigationManager Navigation
@inject AuthService AuthService
@inject ApiService ApiService

<PageTitle>Profile</PageTitle>

@if (IsOwnProfile)
{
    <AuthorizeView>
        <Authorized>
            <UserPage settingsModel="settingsModel" user="user" userReviews="userReviews" favoriteGameCards="favoriteGameCards" totalPagesFavorite="totalPagesFavorite" totalPagesReviews="totalPagesReviews" OnUserUpdated="@ReloadUserData" />
        </Authorized>
        <NotAuthorized>
            @{ Navigation.NavigateTo("/login", true); }
        </NotAuthorized>
    </AuthorizeView>
}
else
{
    <UserPage user="user" userReviews="userReviews" favoriteGameCards="favoriteGameCards" totalPagesFavorite="totalPagesFavorite" totalPagesReviews="totalPagesReviews" />
}

@code {
    private IUserDto? user;
    [Parameter] public int? Id { get; set; } 
    private bool IsOwnProfile => Id == null; // Si no hay Id, es /profile


    private List<DetailReviewDto> userReviews = new();
    private CardContainer[]? favoriteGameCards;
    private int totalPagesFavorite = 1;
    private int totalPagesReviews = 1;

    private RegisterForm settingsModel = new();
    
    protected override async Task OnInitializedAsync()
    {
        await LoadUserData();
    }

    private async Task LoadUserData()
    {
        if (IsOwnProfile)
        {
            // Cargar perfil privado
            user = await ApiService.PrivateGetAsync<PrivateUserDto>(APIUTILS.URIS.PROFILE);
            var privateuser = user as PrivateUserDto;
            settingsModel = new RegisterForm
            {
                Username = privateuser?.Username ?? "",
                FullName = privateuser?.FullName ?? "",
                Email = privateuser?.Email,
                Birthday = privateuser?.Birthday,
                Country = privateuser?.Country,
                Password = ""
            };
        }
        else
        {
            // Cargar perfil p√∫blico usando el Id
            user = await ApiService.PublicGetByIdAsync<PublicUserDto>(APIUTILS.URIS.USERS, Id ?? 0);
        }
        userReviews = user?.Reviews.Data.ToList() ?? new List<DetailReviewDto>();
        totalPagesFavorite = (int)Math.Ceiling((double)(user?.Favorites.TotalCount ?? 0) / (user?.Favorites.PageSize ?? 1));
        totalPagesReviews = (int)Math.Ceiling((double)(user?.Reviews.TotalCount ?? 0) / (user?.Reviews.PageSize ?? 1));
        favoriteGameCards = user?.Favorites.Data.Where(r => r.Game != null)
                                                .Select(r => new CardContainer(new BasicGameCardStrat(false), r.Game!))
                                                .ToArray();

        Console.WriteLine($"Profile initialized, user: {user?.Username}, reviews loaded: {userReviews.Count}, favorite games loaded: {favoriteGameCards?.Length}, totalPagesFavorite: {totalPagesFavorite}, totalPagesReviews: {totalPagesReviews}, pagesizeFavorite: {user?.Favorites.PageSize}, pagesizeReviews: {user?.Reviews.PageSize}, totalCountFavorite: {user?.Favorites.TotalCount}, totalCountReviews: {user?.Reviews.TotalCount}");
    }

    private async Task ReloadUserData()
    {
        await LoadUserData();
        StateHasChanged();
    }
}
