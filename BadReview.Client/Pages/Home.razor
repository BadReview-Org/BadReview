@page "/"
@implements IDisposable

@using BadReview.Shared.DTOs.Response
@using BadReview.Client.Utils
@using BadReview.Shared.Utils

@inject HttpClient Client
@inject ApiService ApiService
@inject NavigationManager Navigation


<PageTitle>BadReview - Home</PageTitle>

@if (isLoading)
{
    <!-- Loading Skeleton -->
    <MudContainer MaxWidth="MaxWidth.ExtraLarge" Class="mt-6">
        <MudSkeleton SkeletonType="SkeletonType.Rectangle" Height="500px" Class="rounded-lg mb-6" />
        <MudSkeleton SkeletonType="SkeletonType.Rectangle" Height="200px" Class="rounded-lg mb-6" />
        <MudSkeleton SkeletonType="SkeletonType.Rectangle" Height="200px" Class="rounded-lg mb-6" />
        <MudSkeleton SkeletonType="SkeletonType.Rectangle" Height="200px" Class="rounded-lg" />
    </MudContainer>
}
else
{
    <MudContainer MaxWidth="MaxWidth.ExtraLarge" Class="mt-6">
        <!-- Hero Carousel - Games of the Week -->
        <MudPaper Elevation="8" Class="mb-8 rounded-lg overflow-hidden">
            <MudCarousel Class="mud-width-full" 
                         Style="height: 500px;" 
                         ShowArrows="true" 
                         ShowBullets="true" 
                         EnableSwipeGesture="true" 
                         AutoCycle="true" 
                         TData="object"
                         AutoCycleTime="TimeSpan.FromSeconds(5)">
                @foreach (var game in trendingGames.Take(5))
                {
                    <MudCarouselItem Transition="Transition.Slide" 
                                     Style="@GetCarouselItemStyle(game.CoverId)">
                        <div class="d-flex align-center justify-center" style="height: 100%; background: rgba(0,0,0,0.5); backdrop-filter: blur(5px);">
                            <MudStack AlignItems="AlignItems.Center" Spacing="3" Style="max-width: 800px; padding: 20px;">
                                <MudText Typo="Typo.h2" Align="Align.Center" Style="font-weight: 700; color: white; text-shadow: 2px 2px 8px rgba(0,0,0,0.8);">
                                    @game.Name
                                </MudText>
                                @if (game.RatingIGDB.HasValue)
                                {
                                    <MudStack Row="true" AlignItems="AlignItems.Center" Spacing="2">
                                        <MudIcon Icon="@Icons.Material.Filled.Star" Color="Color.Warning" Size="Size.Large" />
                                        <MudText Typo="Typo.h4" Style="color: white; font-weight: 600;">
                                            @((game.RatingIGDB.Value / 10).ToString("F1"))
                                        </MudText>
                                    </MudStack>
                                }
                                <MudButton Variant="Variant.Filled" 
                                           Color="Color.Primary" 
                                           Size="Size.Large"
                                           StartIcon="@Icons.Material.Filled.Gamepad"
                                           Href="@($"/game/{game.Id}")"
                                           Style="padding: 12px 40px; font-size: 1.1rem;">
                                    View Details
                                </MudButton>
                            </MudStack>
                        </div>
                    </MudCarouselItem>
                }
            </MudCarousel>
        </MudPaper>

        <!-- Platforms Section -->
        <CustomCarrousel T="PlatformDto" 
                 Items="platforms" 
                 Title="Platforms"
                 Icon="@Icons.Material.Filled.Devices"
                 OnItemClick="@(platform => Navigation.NavigateTo($"/platform/{platform.Id}"))"
                 DropdownChanged="@(platform => Navigation.NavigateTo($"/platform/{platform.Id}"))"
                 URI = "@APIUTILS.URIS.PLATFORMS"
                 >
            <ItemTemplate Context="platform">
                <MudIcon Icon="@IconsMap.PlatformTypeIcon[(IconsMap.PlatformTypes)(platform.PlatformType ?? 0)]" 
                         Size="Size.Large" 
                         Style="color: white;"/>
                <MudText Typo="Typo.h6" Align="Align.Center" Class="mt-2" Style="color: white;
                                            display: -webkit-box; 
                                            -webkit-line-clamp: 1; 
                                            -webkit-box-orient: vertical; 
                                            overflow: hidden;;">
                    @platform.Name
                </MudText>
            
            </ItemTemplate>
            <DropdownTemplate Context="platform">
                <MudStack Row ="true" AlignItems="AlignItems.Center" Spacing="2" >
                    <MudImage Src="@ImageHelper.GetCoverUrl(platform.LogoId)" 
                                Alt="@platform.Name" 
                                Style="height: 50px; width: 50px; margin-bottom: 10px;" />
                    <MudText Typo="Typo.subtitle1" Align="Align.Left" Style="color: white;">
                        @platform.Name
                    </MudText>
                </MudStack>
            </DropdownTemplate>
        </CustomCarrousel>

        <!-- Genres Section -->
        <CustomCarrousel T="GenreDto" 
                        Items="genres" 
                        Title="Genres"
                        Icon="@Icons.Material.Filled.Category"
                        OnItemClick="@(genre => Navigation.NavigateTo($"/genre/{genre.Id}"))"
                        DropdownChanged="@(genre => Navigation.NavigateTo($"/genre/{genre.Id}"))"
                        URI = "@APIUTILS.URIS.GENRES"
                        >
            <ItemTemplate Context="genre">
                <MudStack AlignItems="AlignItems.Center" Justify="Justify.Center"
                          >
                <MudIcon Icon="@IconsMap.GenreIcon[(IconsMap.Genres)genre.Id]" 
                         Size="Size.Large" 
                         Style="color: white;" />
                <MudText Typo="Typo.h6" Align="Align.Center" Style="color: white;
                            display: -webkit-box; 
                            -webkit-line-clamp: 1; 
                            -webkit-box-orient: vertical; 
                            overflow: hidden;;">
                    @genre.Name
                </MudText>
                </MudStack>
            </ItemTemplate>
            <DropdownTemplate Context="genre">
                <MudStack Row ="true" AlignItems="AlignItems.Center" Spacing="2" >
                    <MudIcon Icon="@IconsMap.GenreIcon[(IconsMap.Genres)genre.Id]" 
                         Size="Size.Large" 
                         Style="color: white;" />
                    <MudText Typo="Typo.subtitle1" Align="Align.Left" Style="color: white;">
                        @genre.Name
                    </MudText>
                </MudStack>
            </DropdownTemplate>
        </CustomCarrousel>

        <!-- Developers Section -->
        <CustomCarrousel T="BasicDeveloperDto" 
                 Items="developers" 
                 Title="Developers"
                 Icon="@Icons.Material.Filled.Code"
                 OnItemClick="@(dev => Navigation.NavigateTo($"/developer/{dev.Id}"))"
                 DropdownChanged="@(dev => Navigation.NavigateTo($"/developer/{dev.Id}"))"
                 URI = "@APIUTILS.URIS.DEVELOPERS">
                <ItemTemplate Context="dev">
                    @if (!string.IsNullOrEmpty(dev.LogoId))
                    {
                        <MudImage Src="@ImageHelper.GetCoverUrl(dev.LogoId)" 
                                Alt="@dev.Name" 
                                Style="max-height: 80px; max-width: 150px;" />
                    }
                    <MudText Typo="Typo.h6" Align="Align.Center" Class="mt-2" Style="color: white;"
                    >
                        @dev.Name
                    </MudText>
                </ItemTemplate>
                <DropdownTemplate Context="dev">
                    <MudStack Row ="true" AlignItems="AlignItems.Center" Spacing="2" >
                        <MudImage Src="@ImageHelper.GetCoverUrl(dev.LogoId)" 
                                    Alt="@dev.Name" 
                                    Style="height: 50px; width: 50px; margin-bottom: 10px;" />
                        <MudText Typo="Typo.subtitle1" Align="Align.Left" Style="color: white;">
                            @dev.Name
                        </MudText>
                    </MudStack>
                </DropdownTemplate>
        </CustomCarrousel>
    </MudContainer>
}

<style>
    .platform-card, .genre-card, .developer-card {
        transition: transform 0.3s ease, box-shadow 0.3s ease;
    }

    .platform-card:hover, .genre-card:hover, .developer-card:hover {
        transform: translateY(-8px);
        box-shadow: 0 12px 40px rgba(0,0,0,0.4);
    }
</style>

@code {
    private bool _open = false;
    private bool isLoading = true;
    private List<BasicGameDto> trendingGames = new();
    private List<PlatformDto> platforms = new();
    private List<GenreDto> genres = new();
    private List<BasicDeveloperDto> developers = new();

    private int platformScrollPosition = 0;
    private int genreScrollPosition = 0;
    private int developerScrollPosition = 0;

    private System.Threading.Timer? platformTimer;
    private System.Threading.Timer? genreTimer;
    private System.Threading.Timer? developerTimer;

    protected override async Task OnInitializedAsync()
    {
        await LoadData();
        StartAutoScroll();
    }

    private void StartAutoScroll()
    {
        // Auto-scroll platforms a la derecha cada 3 segundos
        platformTimer = new System.Threading.Timer(_ =>
        {
            InvokeAsync(() =>
            {
                ScrollPlatforms(1);
            });
        }, null, TimeSpan.FromSeconds(3), TimeSpan.FromSeconds(3));

        // Auto-scroll genres a la izquierda cada 3.5 segundos
        genreTimer = new System.Threading.Timer(_ =>
        {
            InvokeAsync(() =>
            {
                ScrollGenres(1); // Recuerda que genres tiene dirección inversa
            });
        }, null, TimeSpan.FromSeconds(3.5), TimeSpan.FromSeconds(3.5));

        // Auto-scroll developers a la derecha cada 4 segundos
        developerTimer = new System.Threading.Timer(_ =>
        {
            InvokeAsync(() =>
            {
                ScrollDevelopers(1);
            });
        }, null, TimeSpan.FromSeconds(4), TimeSpan.FromSeconds(4));
    }

    public void Dispose()
    {
        platformTimer?.Dispose();
        genreTimer?.Dispose();
        developerTimer?.Dispose();
    }

    private async Task LoadData()
    {
        try
        {
            // Cargar trending games
            var trendingRequest = new ApiRequest
            {
                URI = APIUTILS.URIS.TRENDING,
                Page = 0,
                PageSize = 5
            };
            var trendingResult = await ApiService.GetManyAsync<BasicGameDto>(trendingRequest);
            trendingGames = trendingResult?.Data.ToList() ?? new List<BasicGameDto>();

            // Cargar platforms
            var platformRequest = new ApiRequest
            {
                URI = APIUTILS.URIS.PLATFORMS,
                Page = 0,
                PageSize = 20,
                Filters = "platform_logo != null"
            };
            var platformResult = await ApiService.GetManyAsync<PlatformDto>(platformRequest);
            platforms = platformResult?.Data.ToList() ?? new List<PlatformDto>();

            // Cargar genres
            var genreRequest = new ApiRequest
            {
                URI = APIUTILS.URIS.GENRES,
                Page = 0,
                PageSize = 20
            };
            var genreResult = await ApiService.GetManyAsync<GenreDto>(genreRequest);
            genres = genreResult?.Data.ToList() ?? new List<GenreDto>();

            // Cargar developers
            var developerRequest = new ApiRequest
            {
                URI = APIUTILS.URIS.DEVELOPERS,
                Page = 0,
                PageSize = 20,
                Filters = "logo != null"
            };
            var developerResult = await ApiService.GetManyAsync<BasicDeveloperDto>(developerRequest);
            developers = developerResult?.Data.ToList() ?? new List<BasicDeveloperDto>();
        }
        catch (Exception ex)
        {
            Console.WriteLine($"Error loading home data: {ex.Message}");
        }
        finally
        {
            isLoading = false;
        }
    }

    private string GetCarouselItemStyle(string? coverId)
    {
        if (string.IsNullOrEmpty(coverId))
            return "background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);";
        
        var imageUrl = ImageHelper.GetCoverUrl(coverId);
        return $"background: url('{imageUrl}') center/cover no-repeat;";
    }

    private void ScrollPlatforms(int direction)
    {
        platformScrollPosition += direction * 220;
        
        // Reset cuando llega al límite (bucle infinito)
        var maxScroll = -(platforms.Count * 220);
        if (platformScrollPosition < maxScroll)
            platformScrollPosition = 0;
        else if (platformScrollPosition > 0)
            platformScrollPosition = maxScroll;
            
        StateHasChanged();
    }

    private void ScrollGenres(int direction)
    {
        genreScrollPosition += direction * 220;
        
        // Reset cuando llega al límite (bucle infinito)
        var maxScroll = -(genres.Count * 220);
        if (genreScrollPosition < maxScroll)
            genreScrollPosition = 0;
        else if (genreScrollPosition > 0)
            genreScrollPosition = maxScroll;
            
        StateHasChanged();
    }

    private void ScrollDevelopers(int direction)
    {
        developerScrollPosition += direction * 220;
        
        // Reset cuando llega al límite (bucle infinito)
        var maxScroll = -(developers.Count * 220);
        if (developerScrollPosition < maxScroll)
            developerScrollPosition = 0;
        else if (developerScrollPosition > 0)
            developerScrollPosition = maxScroll;
            
        StateHasChanged();
    }
    // Get scroll style for MudStack
    private string GetScrollStyle(int position)
    {
        return $"transform: translateX({position}px); transition: transform 0.5s ease;";
    }

    private string GetGenreGradient(int index)
    {
        var gradients = new[]
        {
            "linear-gradient(135deg, #667eea 0%, #764ba2 100%)",
            "linear-gradient(135deg, #f093fb 0%, #f5576c 100%)",
            "linear-gradient(135deg, #4facfe 0%, #00f2fe 100%)",
            "linear-gradient(135deg, #43e97b 0%, #38f9d7 100%)",
            "linear-gradient(135deg, #fa709a 0%, #fee140 100%)",
            "linear-gradient(135deg, #30cfd0 0%, #330867 100%)",
            "linear-gradient(135deg, #a8edea 0%, #fed6e3 100%)",
            "linear-gradient(135deg, #ff9a9e 0%, #fecfef 100%)",
            "linear-gradient(135deg, #ffecd2 0%, #fcb69f 100%)",
            "linear-gradient(135deg, #ff6e7f 0%, #bfe9ff 100%)",
            "linear-gradient(135deg, #e0c3fc 0%, #8ec5fc 100%)",
            "linear-gradient(135deg, #f8b500 0%, #fceabb 100%)"
        };
        return gradients[index % gradients.Length];
    }

    private string GetGenreIcon(string genreName)
    {
        return genreName.ToLower() switch
        {
            var n when n.Contains("action") => Icons.Material.Filled.SportsMartialArts,
            var n when n.Contains("adventure") => Icons.Material.Filled.Explore,
            var n when n.Contains("rpg") || n.Contains("role") => Icons.Material.Filled.Castle,
            var n when n.Contains("strategy") || n.Contains("rts") || n.Contains("tbs") => Icons.Material.Filled.Psychology,
            var n when n.Contains("shooter") => Icons.Material.Filled.GpsFixed,
            var n when n.Contains("puzzle") => Icons.Material.Filled.Extension,
            var n when n.Contains("racing") => Icons.Material.Filled.DirectionsCar,
            var n when n.Contains("sport") => Icons.Material.Filled.SportsSoccer,
            var n when n.Contains("fighting") => Icons.Material.Filled.SportsKabaddi,
            var n when n.Contains("horror") => Icons.Material.Filled.Nightlight,
            var n when n.Contains("simulation") || n.Contains("simulator") => Icons.Material.Filled.Computer,
            var n when n.Contains("platformer") || n.Contains("platform") => Icons.Material.Filled.Stairs,
            var n when n.Contains("arcade") => Icons.Material.Filled.SportsEsports,
            var n when n.Contains("card") || n.Contains("board") => Icons.Material.Filled.Style,
            var n when n.Contains("hack") || n.Contains("slash") || n.Contains("beat") => Icons.Material.Filled.Whatshot,
            var n when n.Contains("indie") => Icons.Material.Filled.EmojiObjects,
            var n when n.Contains("moba") => Icons.Material.Filled.Groups,
            var n when n.Contains("music") => Icons.Material.Filled.MusicNote,
            var n when n.Contains("pinball") => Icons.Material.Filled.Album,
            var n when n.Contains("point") || n.Contains("click") => Icons.Material.Filled.TouchApp,
            var n when n.Contains("quiz") || n.Contains("trivia") => Icons.Material.Filled.Quiz,
            var n when n.Contains("tactical") => Icons.Material.Filled.Shield,
            var n when n.Contains("visual novel") => Icons.Material.Filled.MenuBook,
            _ => Icons.Material.Filled.VideogameAsset
        };
    }
}