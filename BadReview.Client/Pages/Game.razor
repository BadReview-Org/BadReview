@page "/game/{id:int}"
@using BadReview.Shared.DTOs.Response
@using BadReview.Client.Utils
@using BadReview.Shared.Utils
@using Microsoft.JSInterop
@inject HttpClient Client
@inject NavigationManager Navigation
@inject IJSRuntime JS
@inject ApiService ApiService
@inject AuthenticationStateProvider _AuthStateProvider

<PageTitle>@gameDetails?.Name</PageTitle>

@if (gameDetails == null)
{
    <MudContainer MaxWidth="MaxWidth.Large" Class="mt-6">
        <MudGrid>
            <MudItem xs="12" md="4">
                <MudSkeleton SkeletonType="SkeletonType.Rectangle" Height="600px" />
            </MudItem>
            <MudItem xs="12" md="8">
                <MudSkeleton SkeletonType="SkeletonType.Rectangle" Height="100px" Class="mb-4" />
                <MudSkeleton SkeletonType="SkeletonType.Rectangle" Height="200px" Class="mb-4" />
                <MudSkeleton SkeletonType="SkeletonType.Rectangle" Height="400px" />
            </MudItem>
        </MudGrid>
    </MudContainer>
}
else
{
    <MudContainer MaxWidth="MaxWidth.ExtraExtraLarge" Class="mt-6">
        <MudGrid Spacing="4">
            <MudItem xs="12" md="12" lg="12">
            <!-- Título con Gradient dinámico basado en la cover -->
                <MudPaper Class="pa-4" Elevation="8" Style="@($"background: linear-gradient(135deg, {primaryColor} 0%, {secondaryColor} 100%); border-radius: 12px; transition: background 0.5s ease;")">
                    <MudText Align="Align.Center" Typo="Typo.h2" Style="font-weight: 700; color: white; text-shadow: 2px 2px 4px rgba(0,0,0,0.3);">
                        @gameDetails.Name <br />
                        <MudText Typo="Typo.body2" Style="color: rgba(255,255,255,0.9);">
                            @(gameDetails.Date.HasValue ? "Released" : "Will be Released") @(gameDetails.Date.HasValue ? DateTimeOffset.FromUnixTimeSeconds(gameDetails.Date.Value).DateTime.ToString("d 'de' MMMM, yyyy") : "TBA")
                        </MudText>
                    </MudText>
                </MudPaper>
            </MudItem>
            <!-- Cover y Info Lateral - Primera Columna -->
            <MudItem xs="12" md="6" lg="3">
                <MudStack Spacing="3">
                    <!-- Cover Image -->
                    <MudPaper Elevation="10" Class="pa-3 mud-elevation-hover" Style="background: linear-gradient(145deg, #2a2a2a, #1a1a1a); transition: all 0.3s ease;">
                        <MudImage Src="@ImageHelper.GetCoverUrl(gameDetails.CoverId)" 
                                  Alt="@gameDetails.Name" 
                                  Class="rounded-lg" 
                                  Style="width: 100%; height: auto; box-shadow: 0 8px 32px rgba(0,0,0,0.4);" />
                        <MudStack Row="true" AlignItems="AlignItems.Center" Justify="Justify.Center" Spacing="1" Class="mt-1">
                        @if (gameDetails.RatingIGDB.HasValue)
                            {
                            <img src="IGDB_logo-white.svg.png" alt="IGDB" style="height: 16px; width: auto; opacity: 0.8;" />
                            <MudText Typo="Typo.body2" Style="color: #b0b0b0; font-size: 0.85rem; font-weight: 500;">
                                @((gameDetails.RatingIGDB.Value / 10).ToString("F1", System.Globalization.CultureInfo.InvariantCulture))
                            </MudText>
                            }
                        @if (gameDetails.Count_RatingBadReview > 0)
                            {
                            <img src="icon-192_white.png" alt="BadReview" style="height: 16px; width: auto; opacity: 0.8;" />
                            <MudText Typo="Typo.body2" Style="color: #b0b0b0; font-size: 0.85rem; font-weight: 500;">
                                @((gameDetails.Total_RatingBadReview / gameDetails.Count_RatingBadReview).ToString("F1", System.Globalization.CultureInfo.InvariantCulture))
                            </MudText>
                            }
                        <MudToggleIconButton Toggled="@(userReview?.IsFavorite ?? false)"
                            Icon="@Icons.Material.Filled.FavoriteBorder"
                            Color="@Color.Error"
                            ToggledIcon="@Icons.Material.Filled.Favorite"
                            ToggledColor="@Color.Error"
                            ToggledChanged="@OnFavoriteChanged"
                            />
                        </MudStack>
                              
                        
 
                    </MudPaper>
                    <!-- User Review Section -->
                    <MudPaper Elevation ="6" Class="pa-3" Style="background: linear-gradient(145deg, #2a2a2a, #1a1a1a);">
                    <AuthorizeView>
                        <Authorized>
                            <div class="d-flex">
                                <MudButton OnClick="OpenDialog" FullWidth=true Variant="Variant.Filled" Color="Color.Primary">
                                    @(userReview is null || userReview.Rating == 0 || userReview.Rating is null ? "Rate" : "Edit rating")
                                </MudButton>
                                @if (userReview != null && userReview.Rating > 0){
                                    <MudRating Color=Color.Warning SelectedValue="@(userReview?.Rating ?? 0)" Disabled="true" Class="mt-1 ml-3" />
                                }
                            </div>
                            
                        </Authorized>
                        <NotAuthorized>
                            <p>Create an account or log in to register your activity!</p>
                        </NotAuthorized>
                    </AuthorizeView>
                    </MudPaper>

                    <CustomDialog @ref="popupReview"
                                            Title="Create a review"
                                            Icon="@Icons.Material.Filled.Star"
                                            OnConfirm = "PostReview">
                        <MudStack Spacing="3">
                            <MudStack Row="true" AlignItems="AlignItems.Center" Spacing="2">
                                <MudText Typo="Typo.body1">Rating:</MudText>
                                <MudRating @bind-SelectedValue="currentRating" MaxValue="5" ReadOnly="false" />
                            </MudStack>
                            <MudStack Row="true" AlignItems="AlignItems.Center" Spacing="2">
                                <MudText Typo="Typo.body1">Status:</MudText>
                                <MudButtonGroup Color="Color.Primary" Variant="Variant.Outlined">
                                    <MudButton>@_buttonText</MudButton>
                                    <MudMenu Icon="@Icons.Material.Filled.ArrowDropDown" Style="align-self: auto;">
                                        <MudMenuItem OnClick="() => SetButtonText(ReviewState.NONE)">None</MudMenuItem>
                                        <MudMenuItem OnClick="() => SetButtonText(ReviewState.PLAYED)">Played</MudMenuItem>
                                        <MudMenuItem OnClick="() => SetButtonText(ReviewState.PLAYING)">Playing</MudMenuItem>
                                        <MudMenuItem OnClick="() => SetButtonText(ReviewState.WISHLIST)">Wishlist</MudMenuItem>
                                    </MudMenu>
                                </MudButtonGroup>
                            </MudStack>
                            <MudTextField @bind-Value="reviewText" 
                                          Label="Comment" 
                                          Variant="Variant.Outlined" 
                                          Lines="5" 
                                          Placeholder="Write your review here..." />
                        </MudStack>
                    </CustomDialog>
                    

                    
                </MudStack>
            </MudItem>
            
            <!-- Contenido Principal - Segunda Columna -->
            <MudItem xs="12" md="6" lg="6">
                <MudStack Spacing="4">

                    <!-- Description -->
                    <MudPaper Class="pa-4" Elevation="6" Style="background: linear-gradient(145deg, #2a2a2a, #1a1a1a);">
                        <MudText Typo="Typo.h5" Class="mb-3" Style="color: #667eea;">
                            <MudIcon Icon="@Icons.Material.Filled.Description" Size="Size.Medium" Class="mr-2" />
                            About This Game
                        </MudText>
                        <MudText Typo="Typo.body1" Style="line-height: 1.8; color: #e0e0e0;">
                            @gameDetails.Summary
                        </MudText>
                    </MudPaper>
                    <!-- Video Trailer -->
                    @if (!string.IsNullOrEmpty(gameDetails.Video))
                    {
                        <MudPaper Class="pa-4" Elevation="8" Style="background: linear-gradient(145deg, #2a2a2a, #1a1a1a);">
                            <MudText Typo="Typo.h5" Class="mb-3" Style="color: #764ba2;">
                                <MudIcon Icon="@Icons.Material.Filled.PlayCircle" Size="Size.Medium" Class="mr-2" />
                                Game Trailer
                            </MudText>
                            <div style="position: relative; padding-bottom: 56.25%; height: 0; overflow: hidden; border-radius: 8px; box-shadow: 0 8px 32px rgba(0,0,0,0.4);">
                                <iframe style="position: absolute; top: 0; left: 0; width: 100%; height: 100%;"
                                        src="https://www.youtube.com/embed/@(gameDetails.Video)?autoplay=1&mute=0"
                                        title="YouTube video player"
                                        frameborder="0"
                                        allow="accelerometer; autoplay; clipboard-write; encrypted-media; gyroscope; picture-in-picture"
                                        allowfullscreen>
                                </iframe>
                            </div>
                        </MudPaper>
                    }
                </MudStack>
            </MudItem>


            
            <!-- Tercera Columna - Genres y Platforms -->
            <MudItem xs="12" md="12" lg="3">
                <MudStack Spacing="3">
                    <!-- Genres -->
                    @if (gameDetails.Genres?.Any() == true)
                    {
                        <MudPaper Class="pa-3" Elevation="6" Style="background: linear-gradient(145deg, #2a2a2a, #1a1a1a);">
                            <MudText Typo="Typo.h6" Class="mb-2">
                                <MudIcon Icon="@Icons.Material.Filled.Category" Size="Size.Small" Class="mr-2" />
                                Genres
                            </MudText>
                            <MudStack Row="true" Spacing="1" Wrap="Wrap.Wrap">
                                @foreach (var genre in gameDetails.Genres)
                                {
                                    <MudChip T="string" Size="Size.Small" Color="Color.Primary" Variant="Variant.Filled">
                                        @genre.Name
                                    </MudChip>
                                }
                            </MudStack>
                        </MudPaper>
                    }

                    <!-- Platforms -->
                    @if (gameDetails.Platforms?.Any() == true)
                    {
                        <MudPaper Class="pa-3" Elevation="6" Style="background: linear-gradient(145deg, #2a2a2a, #1a1a1a);">
                            <MudText Typo="Typo.h6" Class="mb-2">
                                <MudIcon Icon="@Icons.Material.Filled.Devices" Size="Size.Small" Class="mr-2" />
                                Platforms
                            </MudText>
                            <MudStack Row="true" Spacing="1" Wrap="Wrap.Wrap">
                                @foreach (var platform in gameDetails.Platforms)
                                {
                                    <MudChip T="string" Size="Size.Small" Color="Color.Secondary" Variant="Variant.Filled">
                                        @platform.Name
                                    </MudChip>
                                }
                            </MudStack>
                        </MudPaper>
                    }

                    <!-- Developers -->
                    @if (gameDetails.Developers?.Any() == true)
                    {
                        <MudPaper Class="pa-3" Elevation="6" Style="background: linear-gradient(145deg, #2a2a2a, #1a1a1a);">
                            <MudText Typo="Typo.h6" Class="mb-2">
                                <MudIcon Icon="@Icons.Material.Filled.Code" Size="Size.Small" Class="mr-2" />
                                Developers
                            </MudText>
                            @foreach (DetailDeveloperDto developer in gameDetails.Developers)
                            {
                                <MudText Typo="Typo.body2" Color="Color.Default">
                                <MudImage Src="@ImageHelper.GetCoverUrl(developer.LogoId)" Alt="@developer.Name" Width="32" Height="32" Class="ml-2" Style="vertical-align: middle; border-radius: 4px;" />
                                    @developer.Name                     
                                </MudText>
                            }
                        </MudPaper>
                    }
                </MudStack>
            </MudItem>
            <MudItem xs="12" md="12" lg="12">
            <!-- Reviews -->
                <CustomGridCard lg = "12" xs = "12" md = "12" arrayElement="reviewCards"
                    placeholderTitle="There aren't any reviews for this game yet." placeholderBody="Wanna try to write the first one?" />
            </MudItem>
        </MudGrid>
    </MudContainer>
}

@code {
    [Parameter]
    public int id { get; set; }
    private DetailGameDto? gameDetails;

    private CardContainer[]? reviewCards;
    private string primaryColor = "#667eea";
    private string secondaryColor = "#764ba2";

    private string _buttonText = "Select Action";

    int currentRating = 0;

    private ReviewState reviewState = ReviewState.NONE;

    private DetailReviewDto? userReview;

    private JWTAuthStateProvider AuthStateProvider = null!;
    private string reviewText = "";
    private CustomDialog? popupReview;
    private void OpenDialog() => popupReview?.Open();

    private void SetButtonText(ReviewState option)
    {
        switch (option)
        {
            case ReviewState.NONE:
                reviewState = ReviewState.NONE;
                _buttonText = "None";
                break;
            case ReviewState.PLAYED:
                reviewState = ReviewState.PLAYED;
                _buttonText = "Played";
                break;
            case ReviewState.PLAYING:
                reviewState = ReviewState.PLAYING;
                _buttonText = "Playing";
                break;
            case ReviewState.WISHLIST:
                reviewState = ReviewState.WISHLIST;
                _buttonText = "Wishlist";
                break;
            default:
                _buttonText = "Select Action";
                break;
        }
    }
    
    protected async Task PostReview()
    {
        var reviewData = new CreateReviewRequest(
                Rating: currentRating,
                StartDate: DateTime.UtcNow,
                EndDate: DateTime.UtcNow,
                ReviewText: reviewText,
                StateEnum: reviewState,
                IsFavorite: userReview?.IsFavorite ?? false,
                IsReview: true,
                GameId: id
            );
        if(userReview is null)
            userReview = await ApiService.PostAsync<CreateReviewRequest,DetailReviewDto>(APIUTILS.URIS.REVIEWS, reviewData);
        else
            userReview = await ApiService.PutAsync<CreateReviewRequest,DetailReviewDto>($"{APIUTILS.URIS.REVIEWS}/{userReview.Id}", reviewData);
        
    }


    protected override async Task OnInitializedAsync()
    {
        AuthStateProvider = (JWTAuthStateProvider) _AuthStateProvider;
        // Verificar si el usuario está autenticado

        var authState = await AuthStateProvider.GetAuthenticationStateAsync();
        var isAuthenticated = authState.User.Identity?.IsAuthenticated ?? false;
        
        // Usar endpoint apropiado según autenticación
        if (isAuthenticated)
        {
            // Usuario autenticado - usar endpoint privado (sin /public)
            var response = await ApiService.PrivateGetByIdAsync<PrivateDetailGameDto>("games/private", id);
            gameDetails = response?.game;
            userReview = response?.userReview;
        }
        else
        {
            // Usuario NO autenticado - endpoint público
            gameDetails = await ApiService.PublicGetByIdAsync<DetailGameDto>("games/public", id);
        }
        
        if (gameDetails == null)
        {
            Navigation.NavigateTo("/trending-games");
            return;
        }  
        
        // Cargar reviews
        reviewCards = gameDetails.Reviews.Data
            .Select(r => new CardContainer(new DetailReviewCardStrat(), r)).ToArray();

        // Extract colors from cover image
        await ExtractColorsFromCover();
    }

    private async Task ExtractColorsFromCover()
    {
        try
        {
            var coverUrl = ImageHelper.GetCoverUrl(gameDetails?.CoverId);
            if (!string.IsNullOrEmpty(coverUrl))
            {
                var colors = await JS.InvokeAsync<ColorPalette>("colorExtractor.extractColors", coverUrl);
                if (colors != null)
                {
                    primaryColor = colors.Primary ?? "#667eea";
                    secondaryColor = colors.Secondary ?? "#764ba2";
                    StateHasChanged();
                }
            }
        }
        catch (Exception ex)
        {
            Console.WriteLine($"Error extracting colors: {ex.Message}");
            // Keep default colors
        }
    }
    private async Task OnFavoriteChanged(bool isFavorite)
    {
        if(isFavorite == true){
            if(userReview == null)
            {
                var favoriteData = new CreateReviewRequest(
                    Rating: null,
                    StartDate: null,
                    EndDate: null,
                    ReviewText: null,
                    StateEnum: ReviewState.NONE,
                    IsFavorite: isFavorite,
                    IsReview: false,
                    GameId: id
                );
                userReview = await ApiService.PostAsync<CreateReviewRequest,DetailReviewDto>(APIUTILS.URIS.REVIEWS, favoriteData);
            }
            else{
                var updateData = new CreateReviewRequest(
                    Rating: userReview.Rating,
                    StartDate: userReview.StartDate,
                    EndDate: userReview.EndDate,
                    ReviewText: userReview.ReviewText,
                    StateEnum: userReview.StateEnum,
                    IsFavorite: isFavorite,
                    IsReview: userReview.IsReview,
                    GameId: id
                );
                userReview = await ApiService.PutAsync<CreateReviewRequest,DetailReviewDto>($"{APIUTILS.URIS.REVIEWS}/{userReview.Id}", updateData);
            }
        }
        else{
            if(userReview?.IsReview == true)
            {
                var exfavorite = new CreateReviewRequest(
                    Rating: userReview.Rating,
                    StartDate: userReview.StartDate,
                    EndDate: userReview.EndDate,
                    ReviewText: userReview.ReviewText,
                    StateEnum: userReview.StateEnum,
                    IsFavorite: isFavorite,
                    IsReview: userReview.IsReview,
                    GameId: id
                );
                userReview = await ApiService.PutAsync<CreateReviewRequest,DetailReviewDto>($"{APIUTILS.URIS.REVIEWS}/{userReview.Id}", exfavorite);
            }
            else{
                var deleted = await ApiService.DeleteAsync($"{APIUTILS.URIS.REVIEWS}/{userReview?.Id}");
                if (deleted)
                {
                    userReview = null;
                }
            }
        }
        
        // Forzar actualización del componente después de cambiar el estado
        StateHasChanged();
    }

    private class ColorPalette
    {
        public string? Primary { get; set; }
        public string? Secondary { get; set; }
    }
}
