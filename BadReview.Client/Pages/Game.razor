@page "/game/{id:int}"
@using BadReview.Shared.DTOs.Response
@using BadReview.Client.Utils
@using BadReview.Shared.Utils
@using Microsoft.JSInterop
@inject HttpClient Client
@inject NavigationManager Navigation
@inject IJSRuntime JS
@inject ApiService ApiService
@inject AuthenticationStateProvider _AuthStateProvider

<PageTitle>@gameDetails?.Name</PageTitle>

@if (gameDetails == null)
{
    <MudContainer MaxWidth="MaxWidth.Large" Class="mt-6">
        <MudGrid>
            <MudItem xs="12" md="4">
                <MudSkeleton SkeletonType="SkeletonType.Rectangle" Height="600px" />
            </MudItem>
            <MudItem xs="12" md="8">
                <MudSkeleton SkeletonType="SkeletonType.Rectangle" Height="100px" Class="mb-4" />
                <MudSkeleton SkeletonType="SkeletonType.Rectangle" Height="200px" Class="mb-4" />
                <MudSkeleton SkeletonType="SkeletonType.Rectangle" Height="400px" />
            </MudItem>
        </MudGrid>
    </MudContainer>
}
else
{
    <MudContainer MaxWidth="MaxWidth.ExtraExtraLarge" Class="mt-6">
        <MudGrid Spacing="4">
            <MudItem xs="12" md="12" lg="12">
            <!-- Título con Gradient dinámico basado en la cover -->
                <MudPaper Class="pa-4" Elevation="8" Style="@($"background: linear-gradient(135deg, {primaryColor} 0%, {secondaryColor} 100%); border-radius: 12px; transition: background 0.5s ease;")">
                    <MudText Align="Align.Center" Typo="Typo.h2" Style="font-weight: 700; color: white; text-shadow: 2px 2px 4px rgba(0,0,0,0.3);">
                        @gameDetails.Name <br />
                        <MudText Typo="Typo.body2" Style="color: rgba(255,255,255,0.9);">
                            @(gameDetails.Date.HasValue ? "Released" : "Will be Released") @(gameDetails.Date.HasValue ? DateTimeOffset.FromUnixTimeSeconds(gameDetails.Date.Value).DateTime.ToString("d 'de' MMMM, yyyy") : "TBA")
                        </MudText>
                    </MudText>
                </MudPaper>
            </MudItem>
            <!-- Cover y Info Lateral - Primera Columna -->
            <MudItem xs="12" md="6" lg="3">
                <MudStack Spacing="3">
                    <!-- Cover Image -->
                    <MudPaper Elevation="10" Class="pa-3 mud-elevation-hover" Style="background: linear-gradient(145deg, #2a2a2a, #1a1a1a); transition: all 0.3s ease;">
                        <MudImage Src="@ImageHelper.GetCoverUrl(gameDetails.CoverId)" 
                                  Alt="@gameDetails.Name" 
                                  Class="rounded-lg" 
                                  Style="width: 100%; height: auto; box-shadow: 0 8px 32px rgba(0,0,0,0.4);" />
                        <MudStack Row="true" AlignItems="AlignItems.Center" Justify="Justify.Center" Spacing="1" Class="mt-1">
                        @if (gameDetails.RatingIGDB.HasValue)
                            {
                            <img src="IGDB_logo-white.svg.png" alt="IGDB" style="height: 16px; width: auto; opacity: 0.8;" />
                            <MudText Typo="Typo.body2" Style="color: #b0b0b0; font-size: 0.85rem; font-weight: 500;">
                                @((gameDetails.RatingIGDB.Value / 10).ToString("F1", System.Globalization.CultureInfo.InvariantCulture))
                            </MudText>
                            }
                        @if (gameDetails.Count_RatingBadReview > 0)
                            {
                            <img src="icon-192_white.png" alt="BadReview" style="height: 24px; width: auto; opacity: 0.8;" />
                            <MudText Typo="Typo.body2" Style="color: #b0b0b0; font-size: 0.85rem; font-weight: 500;">
                                @((gameDetails.Total_RatingBadReview / gameDetails.Count_RatingBadReview).ToString("F1", System.Globalization.CultureInfo.InvariantCulture))
                            </MudText>
                            }
                        <AuthorizeView>
                            <Authorized>
                                <MudToggleIconButton Toggled="@(userReview?.IsFavorite ?? false)"
                                    Icon="@Icons.Material.Filled.FavoriteBorder"
                                    Color="@Color.Error"
                                    ToggledIcon="@Icons.Material.Filled.Favorite"
                                    ToggledColor="@Color.Error"
                            ToggledChanged="@OnFavoriteChanged"
                            />
                            </Authorized>
                        </AuthorizeView>
                        </MudStack>
                              
                        
 
                    </MudPaper>
                    <!-- User Review Section -->
                    <UserReviewSection GameId="@id"
                                       UserReview="@userReview"
                                       OnReviewSubmit="PostReview" />

                    
                </MudStack>
            </MudItem>
            
            <!-- Contenido Principal - Segunda Columna -->
            <MudItem xs="12" md="6" lg="6">
                <MudStack Spacing="4">

                    <!-- Description -->
                    <GameDescription Summary="@gameDetails.Summary" />
                    <!-- Video Trailer -->
                    @if (!string.IsNullOrEmpty(gameDetails.Video))
                    {
                        <GameTrailer videoUrl="@gameDetails.Video" />
                    }
                </MudStack>
            </MudItem>
            
            <!-- Tercera Columna - Genres y Platforms -->
            <MudItem xs="12" md="12" lg="3">
                <MudStack Spacing="3">
                    <!-- Genres -->
                    @if (gameDetails.Genres?.Any() == true)
                    {
                    <GameInfoSection TItem="GenreDto"
                                     Title="Genres"
                                     Icon="@Icons.Material.Filled.Category"
                                     Items="@gameDetails.Genres"
                                     ChipColor="Color.Primary"
                                     GetItemText="@(g => g.Name)" 
                                     GetItemHref="@(g => "/genre/" + g.Id)"/>
                    }

                    <!-- Platforms -->
                    @if (gameDetails.Platforms?.Any() == true)
                    {
                    <GameInfoSection TItem="PlatformDto"
                                     Title="Platforms"
                                     Icon="@Icons.Material.Filled.Devices"
                                     Items="@gameDetails.Platforms"
                                     ChipColor="Color.Secondary"
                                     GetItemText="@(p => p.Name)"
                                     GetItemHref="@(p => "/platform/" + p.Id)" />
                    }

                    <!-- Developers -->
                    @if (gameDetails.Developers?.Any() == true)
                    {
                        <GameInfoSection TItem="DetailDeveloperDto"
                                         Title="Developers"
                                         Icon="@Icons.Material.Filled.Code"
                                         Items="@gameDetails.Developers"
                                         RenderAsChips="false">
                            <ItemTemplate Context="developer">
                                <MudLink Href="@($"/developer/{developer.Id}")" Style="text-decoration: none; color: inherit;">
                                    <MudText Typo="Typo.body2" Color="Color.Default">
                                        <MudImage Src="@ImageHelper.GetCoverUrl(developer.LogoId)" Alt="@developer.Name" Width="32" Height="32" Class="ml-2" Style="vertical-align: middle; border-radius: 4px;" />
                                        @developer.Name                     
                                    </MudText>
                                </MudLink>
                            </ItemTemplate>
                        </GameInfoSection>
                    }
                </MudStack>
            </MudItem>
            <MudItem xs="12" md="12" lg="12">
            <!-- Reviews -->
                <ReviewList totalCount="ReviewTotalCount" PageChanged="@OnPageReviewsChanged" Style="true" Reviews="reviews" />
            </MudItem>
        </MudGrid>
    </MudContainer>
}

@code {
    [Parameter]
    public int id { get; set; }
    private DetailGameDto? gameDetails;

    private List<DetailReviewDto>? reviews = null;

    private int ReviewTotalCount = 0;
    private string primaryColor = "#667eea";
    private string secondaryColor = "#764ba2";
    private int currentRating = 0;
    private DetailReviewDto? userReview;
    private JWTAuthStateProvider AuthStateProvider = null!;
    
    protected async Task PostReview(CreateReviewRequest reviewData)
    {
        if(userReview is null)
            userReview = await ApiService.PostAsync<CreateReviewRequest,DetailReviewDto>(APIUTILS.URIS.REVIEWS, reviewData);
        else
            userReview = await ApiService.PutAsync<CreateReviewRequest,DetailReviewDto>($"{APIUTILS.URIS.REVIEWS}/{userReview.Id}", reviewData);
        await OnPageReviewsChanged(1);
    }


    protected override async Task OnInitializedAsync()
    {
        AuthStateProvider = (JWTAuthStateProvider) _AuthStateProvider;
        await LoadGameData();
    }

    protected override async Task OnParametersSetAsync()
    {
        // Este método se llama cuando cambian los parámetros de ruta (como el id)
        await LoadGameData();
    }

    private async Task LoadGameData()
    {
        // Limpiar datos anteriores
        gameDetails = null;
        reviews = new List<DetailReviewDto>();
        userReview = null;
        StateHasChanged(); // Mostrar skeleton mientras carga
        
        // Verificar si el usuario está autenticado
        var authState = await AuthStateProvider.GetAuthenticationStateAsync();
        var isAuthenticated = authState.User.Identity?.IsAuthenticated ?? false;
        
        // Usar endpoint apropiado según autenticación
        if (isAuthenticated)
        {
            // Usuario autenticado - usar endpoint privado (sin /public)
            var response = await ApiService.PrivateGetByIdAsync<PrivateDetailGameDto>(APIUTILS.URIS.PRIVATEGAME, id);
            gameDetails = response?.game;
            userReview = response?.userReview;
            currentRating = userReview?.Rating ?? 0;
        }
        else
        {
            // Usuario NO autenticado - endpoint público
            gameDetails = await ApiService.PublicGetByIdAsync<DetailGameDto>(APIUTILS.URIS.PUBLICGAME, id);
        }
        
        if (gameDetails == null)
        {
            Navigation.NavigateTo("/trending-games");
            return;
        }  
        
        // Cargar reviews
        reviews = gameDetails.Reviews.Data.ToList();
        ReviewTotalCount = gameDetails.Reviews.TotalCount;

        // Extract colors from cover image
        await ExtractColorsFromCover();
        
        StateHasChanged(); // Forzar actualización de la UI
    }

    private async Task ExtractColorsFromCover()
    {
        try
        {
            var coverUrl = ImageHelper.GetCoverUrl(gameDetails?.CoverId);
            if (!string.IsNullOrEmpty(coverUrl))
            {
                var colors = await JS.InvokeAsync<ColorPalette>("colorExtractor.extractColors", coverUrl);
                if (colors != null)
                {
                    primaryColor = colors.Primary ?? "#667eea";
                    secondaryColor = colors.Secondary ?? "#764ba2";
                    StateHasChanged();
                }
            }
        }
        catch (Exception ex)
        {
            Console.WriteLine($"Error extracting colors: {ex.Message}");
            // Keep default colors
        }
    }
    private async Task OnFavoriteChanged(bool isFavorite)
    {
         var favoriteData = new CreateReviewRequest(
                    Rating: userReview != null ? userReview.Rating : 0,
                    StartDate: userReview != null ? userReview.StartDate : null,
                    EndDate: userReview != null ? userReview.EndDate : null,
                    ReviewText: userReview != null ? userReview.ReviewText : null,
                    StateEnum: userReview != null ? userReview.StateEnum : ReviewState.NONE,
                    IsFavorite: isFavorite,
                    IsReview: userReview != null ? userReview.IsReview : false,
                    GameId: id
            );
        if(isFavorite == true){
            if(userReview == null)
                userReview = await ApiService.PostAsync<CreateReviewRequest,DetailReviewDto>(APIUTILS.URIS.REVIEWS, favoriteData); 
            else
                userReview = await ApiService.PutAsync<CreateReviewRequest,DetailReviewDto>($"{APIUTILS.URIS.REVIEWS}/{userReview.Id}", favoriteData);    
        }
        else{
            if(userReview?.IsReview == true)
                userReview = await ApiService.PutAsync<CreateReviewRequest,DetailReviewDto>($"{APIUTILS.URIS.REVIEWS}/{userReview.Id}", favoriteData);
            else{
                var deleted = await ApiService.DeleteAsync($"{APIUTILS.URIS.REVIEWS}/{userReview?.Id}");
                if (deleted)
                    userReview = null;
            }
        }
        
        // Forzar actualización del componente después de cambiar el estado
        StateHasChanged();
    }

    private async Task OnPageReviewsChanged(int page)
    {
        reviews = null; // Mostrar skeleton mientras se carga la nueva página

        try
        {
            var apiRequest = $"?pagesize=10&page={page - 1}&onlyreviewpage=true";

            var response = await ApiService.PublicGetByIdAsync<PagedResult<DetailReviewDto>>(APIUTILS.URIS.PUBLICGAME, id, apiRequest);
            reviews = response?.Data.ToList() ?? new List<DetailReviewDto>();
        }
        catch (Exception ex)
        {
            Console.WriteLine($"Error loading user reviews: {ex.Message}");
        }
        
    }
    private class ColorPalette
    {
        public string? Primary { get; set; }
        public string? Secondary { get; set; }
    }
}
